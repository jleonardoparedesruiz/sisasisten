<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Ajuste para móviles -->
    <meta name="viewport" content="width=device-width, initial-scale=1.2, maximum-scale=1.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
      /* ==============================
         1. Reset y Estilos Generales
         ============================== */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh;
        background: linear-gradient(to right, #ece9e6, #ffffff);
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }
      /* ==============================
         2. Transiciones y Estados
         ============================== */
      .hidden {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .visible {
        opacity: 1;
        pointer-events: auto;
        transition: opacity 0.3s ease;
      }
      /* ==============================
         3. Contenedores: Login, Marcación, Panel Admin,
         Registro Personal, Reportes, Faltas
         ============================== */
      .login-box, .marcacion-box, .admin-panel, .registro-personal,
      .reporte-general, .reporte-individual, .faltas-section {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(229,57,53,0.3);
        margin: 40px auto;
        text-align: center;
      }
      .login-box, .marcacion-box {
        max-width: 400px;
      }
      .admin-panel, .registro-personal, .reporte-general, .reporte-individual, .faltas-section {
        max-width: 1100px;
      }
      .logo {
        text-align: center;
        margin-bottom: 10px;
      }
      .logo img {
        max-width: 150px;
        height: auto;
        display: block;
        margin: 0 auto;
      }
      /* ==============================
         4. Inputs, Botones y Spinner
         ============================== */
      .input-group {
        position: relative;
        margin: 10px 0;
        width: 100%;
      }
      input[type="text"],
      input[type="password"],
      input[type="number"],
      input[type="date"],
      input[type="time"],
      select {
        width: 100%;
        padding: 10px 35px;
        border: 2px solid #ddd;
        border-radius: 5px;
        outline: none;
        box-sizing: border-box;
      }
      input:focus, select:focus {
        border-color: #e53935;
      }
      .input-group i {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
      }
      .input-group .fa-user,
      .input-group .fa-key {
        left: 10px;
      }
      .ver-contraseña {
        right: 10px;
        cursor: pointer;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }
      button {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: filter 0.3s;
        margin-top: 10px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        filter: brightness(0.9);
      }
      .btn-red { background: #e53935; }
      .btn-blue { background: #007bff; }
      .btn-gray { background: #555; }
      .btn-orange { background: #f0ad4e; }
      .mensaje { color: red; margin-top: 10px; }
      footer { color: #888; font-size: 12px; margin-top: 15px; }
      .spinner {
        display: none;
        margin: 10px auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #e53935;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      /* ==============================
         5. Sección de Marcación (Usuarios)
         ============================== */
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 15px;
      }
      #bienvenida {
        font-weight: bold;
        margin: 15px 0;
        color: #333;
      }
      video {
        width: 100%;
        margin-top: 10px;
        border-radius: 8px;
        display: none;
        max-height: 300px;
      }
      /* Etiquetas para Entrada y Salida */
      .marcacion-labels {
        margin: 20px 0;
      }
      .entrada-label, .salida-label {
        padding: 10px;
        border-radius: 5px;
        margin: 5px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .entrada-label {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 5px solid #0c5460;
      }
      .salida-label {
        background: #d4edda;
        color: #155724;
        border-left: 5px solid #155724;
      }
      .entrada-label i, .salida-label i {
        font-size: 18px;
      }
      /* ==============================
         6. Panel de Administración
         ============================== */
      .admin-navbar {
        background-color: #e53935;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 20px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }
      .admin-navbar .logo-admin {
        font-size: 20px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .admin-navbar .menu-admin {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .admin-navbar .menu-admin a {
        color: #fff;
        text-decoration: none;
        font-size: 14px;
        cursor: pointer;
        transition: opacity 0.3s;
      }
      .admin-navbar .menu-admin a:hover {
        opacity: 0.8;
      }
      /* ==============================
         7. Sección Usuarios en Admin
         ============================== */
      .users-section {
        display: none;
        padding: 20px;
      }
      .users-section h4 {
        margin-top: 0;
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
      }
      .form-usuarios {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .form-usuarios .row-fields {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }
      .form-usuarios label {
        font-size: 13px;
        color: #333;
        margin-bottom: 5px;
        display: block;
      }
      .form-usuarios input {
        width: 100%;
        padding: 5px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
        box-sizing: border-box;
      }
      .actions-usuarios {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .actions-usuarios button {
        padding: 8px 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        color: #fff;
        font-size: 14px;
      }
      .btn-clean { background-color: #888; }
      .btn-save { background-color: #e53935; }
      /* ==============================
         8. Tabla de Usuarios
         ============================== */
      .tabla-usuarios-container {
        width: 100%;
        overflow-x: auto;
      }
      .tabla-usuarios {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        table-layout: auto;
      }
      .tabla-usuarios thead {
        background-color: #e53935;
        color: #fff;
      }
      .tabla-usuarios th, .tabla-usuarios td {
        padding: 10px;
        font-size: 13px;
        text-align: left;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }
      .tabla-usuarios th:nth-child(1),
      .tabla-usuarios td:nth-child(1) {
        min-width: 90px;
      }
      .tabla-usuarios tbody tr:hover {
        background-color: #f5f5f5;
      }
      .tabla-usuarios .btn-icon {
        display: inline-block;
        vertical-align: middle;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        margin-right: 4px;
      }
      .tabla-usuarios .btn-icon:last-child {
        margin-right: 0;
      }
      .tabla-usuarios .btn-icon.edit {
        color: #007bff;
      }
      .tabla-usuarios .btn-icon.delete {
        color: #e53935;
      }
      /* ==============================
         9. Fancy Alert Modal (Mensaje)
         ============================== */
      #fancyAlertOverlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #fancyAlertOverlay.active {
        display: flex;
        opacity: 1;
      }
      #fancyAlertBox {
        background: #fff;
        border-radius: 8px;
        padding: 20px 25px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        text-align: center;
        position: relative;
        transform: translateY(-30px);
        transition: transform 0.3s;
      }
      #fancyAlertOverlay.active #fancyAlertBox {
        transform: translateY(0);
      }
      .fancyAlertHeader {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        color: #e53935;
        margin-bottom: 15px;
        justify-content: center;
      }
      .fancyAlertHeader i {
        color: #e53935;
        font-size: 22px;
      }
      #fancyAlertTitle {
        font-weight: bold;
      }
      #fancyAlertMessage {
        font-size: 14px;
        color: #333;
        margin-bottom: 15px;
        white-space: pre-wrap;
      }
      #fancyAlertClose {
        display: block;
        margin: 20px auto 0 auto;
        background: #e53935;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
      }
      #fancyAlertClose:hover {
        filter: brightness(0.9);
      }
      /* ==============================
         10. Fancy Confirm Modal (Confirmación personalizada)
         ============================== */
      #fancyConfirmOverlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #fancyConfirmOverlay.active {
        display: flex;
        opacity: 1;
      }
      #fancyConfirmBox {
        background: #fff;
        border-radius: 8px;
        padding: 20px 25px;
        width: 90%;
        max-width: 350px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        text-align: center;
        position: relative;
        transform: translateY(-30px);
        transition: transform 0.3s;
      }
      #fancyConfirmOverlay.active #fancyConfirmBox {
        transform: translateY(0);
      }
      .button-group-confirm {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      }
      .button-group-confirm button {
        background: #e53935;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
        min-width: 80px;
      }
      .button-group-confirm button:hover {
        filter: brightness(0.9);
      }
      /* ==============================
         11. Sección Geoballas (Administración)
         ============================== */
      .geoballas-section {
        display: none;
        padding: 20px;
        text-align: left;
      }
      .geoballas-section h4 {
        margin-top: 0;
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
      }
      .geoballas-section table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
      }
      .geoballas-section th, .geoballas-section td {
        padding: 8px;
        border: 1px solid #ddd;
        font-size: 13px;
        text-align: left;
      }
      .geoballas-section .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin-right: 4px;
      }
      .geoballas-section .btn-icon.edit {
        color: #007bff;
      }
      .geoballas-section .btn-icon.delete {
        color: #e53935;
      }
      .geoballas-section .btn-icon:hover {
        opacity: 0.8;
      }
      #map {
        width: 100%;
        height: 400px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
      }
      /* ==============================
         12. Nuevo Apartado: Registro Personal de Asistencias
         ============================== */
      .registro-personal {
        background: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 8px 16px rgba(229,57,53,0.3);
        width: 90%;
        max-width: 1100px;
        margin: 40px auto;
        text-align: center;
      }
      .header-registro {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .filtros {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        align-items: center;
      }
      .date-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin: 0 10px;
      }
      .date-group label {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .date-group input[type="date"] {
        border: 1px solid #ccc;
        padding: 6px 10px;
        border-radius: 5px;
      }
      .tabla-registros {
        overflow-x: auto;
      }
      .tabla-registros table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        table-layout: auto;
      }
      .tabla-registros th, .tabla-registros td {
        padding: 10px;
        font-size: 14px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      .tabla-registros th {
        background-color: #e53935;
        color: #fff;
      }
      /* Sección para visualizar faltas del usuario en registro personal */
      .mis-faltas-section {
        margin-top: 20px;
      }
      .mis-faltas-section h4 {
        font-size: 16px;
        color: #333;
        margin-bottom: 10px;
      }
      .mis-faltas-section table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .mis-faltas-section th, .mis-faltas-section td {
        padding: 10px;
        font-size: 13px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      .mis-faltas-section th {
        background-color: #e53935;
        color: #fff;
      }
      /* ==============================
         13. Nuevo Apartado: Reporte General (para Admin)
         ============================== */
      .reporte-general {
        display: none;
        padding: 20px;
      }
      .header-reporte {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .header-reporte h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
      }
      /* ==============================
         14. Nuevo Apartado: Reporte Individual (para Admin)
         ============================== */
      .reporte-individual {
        display: none;
        padding: 20px;
      }
      .reporte-individual .header-reporte h3 {
        font-size: 20px;
        color: #333;
      }
      .reporte-individual .filtros {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
      }
      .reporte-individual .input-group,
      .reporte-individual .date-group {
        max-width: 200px;
      }
      /* Sección para visualizar faltas en reporte individual */
      .mis-faltas-section-individual {
        margin-top: 20px;
      }
      .mis-faltas-section-individual h4 {
        font-size: 16px;
        color: #333;
        margin-bottom: 10px;
      }
      .mis-faltas-section-individual table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .mis-faltas-section-individual th, .mis-faltas-section-individual td {
        padding: 10px;
        font-size: 13px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      .mis-faltas-section-individual th {
        background-color: #e53935;
        color: #fff;
      }
      /* ==============================
         15. Sección Faltas (para Admin)
         ============================== */
      .faltas-section {
        display: none;
        padding: 20px;
      }
      .faltas-section h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
      }
      /* Agregamos inputs para filtrar por fecha dentro de la sección faltas */
      .faltas-section .filtros {
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .faltas-section .filtros .date-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .faltas-section .filtros .date-group label {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .faltas-section table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .faltas-section th, .faltas-section td {
        padding: 10px;
        font-size: 14px;
        text-align: left;
        border-bottom: 1px solid #eee;
      }
      .faltas-section th {
        background-color: #e53935;
        color: #fff;
      }
      /* ==============================
         16. Modal para Añadir Registro
         ============================== */
      .modal {
        display: none;
        position: fixed;
        z-index: 20000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: left;
      }
      .modal h3 {
        margin-top: 0;
      }
      .modal .input-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 14px;
      }
      .modal .input-group input,
      .modal .input-group select,
      .modal .input-group textarea {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: none;
      }
      /* ==============================
         17. Modal para Editar Registro
         ============================== */
      #modalEditRegistro {
        display: none;
        position: fixed;
        z-index: 20000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      #modalEditRegistro .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: left;
      }
      #modalEditRegistro .modal-content h3 {
        margin-top: 0;
      }
      /* ==============================
         18. Modal para Editar Falta
         ============================== */
      #modalEditFalta {
        display: none;
        position: fixed;
        z-index: 20000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }
      #modalEditFalta .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        text-align: left;
      }
      #modalEditFalta .modal-content h3 {
        margin-top: 0;
      }
      @media (max-width: 800px) {
        .form-usuarios .row-fields {
          flex-direction: column;
        }
        .form-usuarios .row-fields > div {
          min-width: auto;
          width: 100%;
        }
      }
      @media (max-width: 600px) {
        .tabla-usuarios th, .tabla-usuarios td,
        .tabla-registros th, .tabla-registros td {
          font-size: 12px;
        }
        .login-box, .marcacion-box {
          width: 95%;
          padding: 20px;
          margin-top: 20px;
        }
        .logo img {
          max-width: 120px;
        }
        .button-group {
          flex-direction: column;
        }
        .admin-navbar .menu-admin {
          gap: 10px;
        }
      }
    </style>
  </head>
  <body onload="inicializarPagina()">
    <!-- LOGIN -->
    <div class="login-box visible" id="loginDiv">
      <div class="logo">
        <img src="https://i.imgur.com/tud5XMS.png" alt="SOLINPA Logo">
      </div>
      <h2><i class="fa-solid fa-lock"></i> Inicia Sesión</h2>
      <h3>Sistema de Asistencia SOLINPA</h3>
      <div class="input-group">
        <i class="fa-solid fa-user"></i>
        <input type="text" id="usuario" placeholder="DNI" required maxlength="8">
      </div>
      <div class="input-group">
        <i class="fa-solid fa-key"></i>
        <input type="password" id="contrasena" placeholder="Clave" required>
        <span class="ver-contraseña" id="iconoOjo">
          <i class="fa-solid fa-eye-slash"></i>
        </span>
      </div>
      <button class="btn-red" id="loginBtn" onclick="enviarLogin()">
        <i class="fa-solid fa-right-to-bracket"></i> Entrar
      </button>
      <div class="spinner" id="loginSpinner"></div>
      <div class="mensaje" id="mensaje"></div>
      <footer>© <span id="anio"></span> - SOLINPA E.I.R.L.</footer>
    </div>
    
    <!-- MARCACIÓN (Usuarios) -->
    <div class="marcacion-box hidden" id="mainContent">
      <div class="logo">
        <img src="https://i.imgur.com/tud5XMS.png" alt="SOLINPA Logo">
      </div>
      <h3>Marque su asistencia</h3>
      <div id="bienvenida">Bienvenido: Usuario</div>
      <div class="button-group">
        <button class="btn-red" id="registroBtn" onclick="registroAsistencia()">
          <i class="fa-solid fa-file-lines"></i> Ir a mi Registro de Asistencias
        </button>
        <button class="btn-blue" id="adminBtn" style="display:none;" onclick="mostrarAdminPanel()">
          <i class="fa-solid fa-user-gear"></i> Ir a Panel de Administrador
        </button>
        <button class="btn-gray" onclick="cerrarSesion()">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
        </button>
      </div>
      <div class="marcacion-labels">
        <div class="entrada-label" id="entradaLabel">
          <i class="fa-solid fa-door-open"></i>
          <span>Entrada: --:--</span>
        </div>
        <div class="salida-label" id="salidaLabel">
          <i class="fa-solid fa-door-closed"></i>
          <span>Salida: --:--</span>
        </div>
      </div>
      <div class="button-group">
        <button class="btn-orange" onclick="iniciarCamara('Entrada')">
          <i class="fa-solid fa-door-open"></i> Marcar Entrada
        </button>
        <button class="btn-orange" onclick="iniciarCamara('Salida')">
          <i class="fa-solid fa-door-closed"></i> Marcar Salida
        </button>
      </div>
      <video id="video" autoplay playsinline></video>
      <div class="mensaje" id="mensajeEvento"></div>
    </div>
    
    <!-- REGISTRO PERSONAL DE ASISTENCIAS (Usuario) -->
    <div class="registro-personal hidden" id="registroPersonal">
      <div class="header-registro">
        <h3>Mi Registro de Asistencias</h3>
        <div class="button-group">
          <button class="btn-gray" onclick="volverAlMenu()">
            <i class="fa-solid fa-arrow-left"></i> Regresar
          </button>
          <button class="btn-gray" onclick="cerrarSesion()">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
          </button>
        </div>
      </div>
      <div class="filtros">
        <div class="date-group">
          <label for="fechaInicio">Fecha Inicio:</label>
          <input type="date" id="fechaInicio">
        </div>
        <div class="date-group">
          <label for="fechaFin">Fecha Fin:</label>
          <input type="date" id="fechaFin">
        </div>
        <button class="btn-blue" onclick="filtrarRegistros()">
          <i class="fa-solid fa-filter"></i> Filtrar
        </button>
      </div>
      <div class="tabla-registros">
        <table id="tablaRegistros">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Hora</th>
              <th>Lugar</th>
            </tr>
          </thead>
          <tbody id="tbodyRegistros"></tbody>
        </table>
      </div>
      <!-- Sección para mostrar las faltas del usuario -->
      <div class="mis-faltas-section" id="misFaltasSection">
        <h4>Mis Faltas</h4>
        <table id="tablaFaltasUsuario">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbodyFaltasUsuario"></tbody>
        </table>
      </div>
    </div>
    
    <!-- PANEL DE ADMINISTRACIÓN -->
    <div class="admin-panel hidden" id="adminPanel">
      <div class="admin-navbar">
        <div class="logo-admin">SOLINPA</div>
        <div class="menu-admin">
          <a onclick="reporteGeneral()">Reporte General</a>
          <a onclick="reporteIndividual()">Reporte Individual</a>
          <a onclick="mostrarEstadisticas()">Estadísticas</a>
          <a onclick="mostrarUsersSection()">Usuarios</a>
          <a onclick="mostrarGeoballas()">Geoballas</a>
          <a onclick="mostrarFaltas()">Faltas</a>
          <a onclick="cerrarSesion()">
            <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión
          </a>
        </div>
      </div>
      <div class="container-admin">
        <h3><i class="fa-solid fa-file"></i> Panel de Administración</h3>
        <p id="adminBienvenida">Bienvenido: <span id="adminNombre">[Nombre Usuario]</span></p>
        <p>Selecciona una opción del menú superior para ver los reportes, estadísticas o gestionar usuarios.</p>
        
        <!-- Sección Usuarios -->
        <div class="users-section" id="usersSection">
          <h4><i class="fa-solid fa-users"></i> Usuarios</h4>
          <div class="form-usuarios">
            <div class="row-fields">
              <div style="flex:1; min-width:200px;">
                <label for="usuarioDni">USUARIO (DNI)</label>
                <input type="text" id="usuarioDni" placeholder="DNI (8 dígitos)" maxlength="8" pattern="^\d{8}$" oninput="this.value=this.value.replace(/\D/g,'').slice(0,8)">
              </div>
              <div style="flex:1; min-width:200px;">
                <label for="nombreCompleto">Nombre Completo</label>
                <input type="text" id="nombreCompleto" placeholder="Ej: Juan Pérez">
              </div>
              <div style="flex:1; min-width:150px;">
                <label for="area">Área</label>
                <input type="text" id="area" placeholder="Área">
              </div>
              <div style="flex:1; min-width:150px;">
                <label for="cargo">Cargo</label>
                <input type="text" id="cargo" placeholder="Cargo">
              </div>
              <div style="flex:1; min-width:200px;">
                <label for="email">Email</label>
                <input type="text" id="email" placeholder="ejemplo@gmail.com">
              </div>
              <div style="flex:1; min-width:150px;">
                <label for="contrasenaUsuario">Contraseña</label>
                <input type="text" id="contrasenaUsuario" placeholder="8 dígitos numéricos" pattern="^\d{8}$">
              </div>
              <div style="flex:1; min-width:100px;">
                <label for="nivel">Nivel</label>
                <input type="number" id="nivel" placeholder="0 o 1">
              </div>
              <div style="flex:1; min-width:120px;">
                <label for="horasExtras">HorasExtras</label>
                <input type="number" id="horasExtras" placeholder="0 o 1">
              </div>
            </div>
            <div class="actions-usuarios">
              <button class="btn-clean" onclick="limpiarFormulario()">
                <i class="fa-solid fa-eraser"></i> Limpiar
              </button>
              <button class="btn-save" id="guardarBtn" onclick="guardarUsuario()">
                <i class="fa-solid fa-floppy-disk"></i> Guardar
              </button>
            </div>
          </div>
          <div class="tabla-usuarios-container">
            <table class="tabla-usuarios" id="tablaUsuarios">
              <thead>
                <tr>
                  <th>Acciones</th>
                  <th>Nombre Completo</th>
                  <th>USUARIO (DNI)</th>
                  <th>Contraseña</th>
                  <th>Área</th>
                  <th>Cargo</th>
                  <th>Email</th>
                  <th>Nivel</th>
                  <th>HorasExtras</th>
                </tr>
              </thead>
              <tbody id="tbodyUsuarios"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Sección Geoballas -->
        <div class="geoballas-section" id="geoballasSection">
          <h4><i class="fa-solid fa-map-location-dot"></i> Geoballas</h4>
          <table class="tabla-geoballas" id="tablaGeoballas">
            <thead>
              <tr>
                <th>Lugar</th>
                <th>Ubicación</th>
                <th>Radio (m)</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyGeoballas"></tbody>
          </table>
          <h5>Agregar/Editar Geoballa</h5>
          <div class="input-group">
            <input type="text" id="geoballaLugar" placeholder="Lugar">
          </div>
          <div class="input-group">
            <input type="text" id="geoballaUbicacion" placeholder="Ubicación (lat, lng)" readonly>
          </div>
          <div class="input-group">
            <input type="number" id="geoballaRadio" placeholder="Radio (m)">
          </div>
          <div id="map"></div>
          <button class="btn-blue" onclick="guardarGeoballa()">Guardar Geoballa</button>
        </div>
        
        <!-- Sección Faltas (Admin) con campos para filtrar por fechas -->
        <div class="faltas-section" id="faltasSection">
          <h3><i class="fa-solid fa-exclamation-circle"></i> Faltas Registradas</h3>
          <!-- Filtros por fecha para faltas -->
          <div class="filtros">
            <div class="date-group">
              <label for="fFechaInicio">Fecha Inicio:</label>
              <input type="date" id="fFechaInicio">
            </div>
            <div class="date-group">
              <label for="fFechaFin">Fecha Fin:</label>
              <input type="date" id="fFechaFin">
            </div>
            <button class="btn-blue" onclick="filtrarFaltasAdmin()">
              <i class="fa-solid fa-filter"></i> Filtrar Faltas
            </button>
          </div>
          <div class="tabla-registros">
            <table id="tablaFaltas">
              <thead>
                <tr>
                  <th>DNI</th>
                  <th>Nombre</th>
                  <th>Fecha</th>
                  <th>Observaciones</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyFaltas"></tbody>
            </table>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- NUEVA SECCIÓN: REPORTE GENERAL (Admin) -->
    <div class="reporte-general hidden" id="reporteGeneralSection">
      <div class="header-reporte">
        <h3><i class="fa-solid fa-table"></i> Reporte General</h3>
        <div class="button-group">
          <button class="btn-gray" onclick="volverAlAdminPanel()">
            <i class="fa-solid fa-arrow-left"></i> Volver a Admin Panel
          </button>
        </div>
      </div>
      <div class="filtros">
        <div class="date-group">
          <label for="rgFechaInicio">Fecha Inicio:</label>
          <input type="date" id="rgFechaInicio">
        </div>
        <div class="date-group">
          <label for="rgFechaFin">Fecha Fin:</label>
          <input type="date" id="rgFechaFin">
        </div>
        <button class="btn-blue" onclick="filtrarReporteGeneral()">
          <i class="fa-solid fa-filter"></i> Filtrar
        </button>
        <button class="btn-blue" onclick="mostrarModalAddRegistro()">
          <i class="fa-solid fa-plus"></i> Añadir Registro
        </button>
      </div>
      <div class="tabla-registros">
        <table id="tablaReporteGeneral">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Tipo</th>
              <th>Observaciones</th>
              <th>Ubicación</th>
              <th>Lugar</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyReporteGeneral"></tbody>
        </table>
      </div>
    </div>
    
    <!-- NUEVA SECCIÓN: REPORTE INDIVIDUAL (Admin) -->
    <div class="reporte-individual hidden" id="reporteIndividualSection">
      <div class="header-reporte">
        <h3><i class="fa-solid fa-user"></i> Reporte Individual</h3>
        <div class="button-group">
          <button class="btn-gray" onclick="volverAlAdminPanel()">
            <i class="fa-solid fa-arrow-left"></i> Volver a Admin Panel
          </button>
        </div>
      </div>
      <div class="filtros">
        <div class="input-group">
          <label for="riDNI">DNI:</label>
          <input type="text" id="riDNI" placeholder="DNI" maxlength="8">
        </div>
        <div class="date-group">
          <label for="riFechaInicio">Fecha Inicio:</label>
          <input type="date" id="riFechaInicio">
        </div>
        <div class="date-group">
          <label for="riFechaFin">Fecha Fin:</label>
          <input type="date" id="riFechaFin">
        </div>
        <div class="input-group">
          <label for="riTipo">Tipo:</label>
          <select id="riTipo">
            <option value="">Todos</option>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
          </select>
        </div>
        <button class="btn-blue" onclick="filtrarReporteIndividual()">
          <i class="fa-solid fa-filter"></i> Filtrar
        </button>
        <button class="btn-blue" onclick="exportarReporteIndividual()">
          <i class="fa-solid fa-file-export"></i> Exportar CSV
        </button>
      </div>
      <div class="tabla-registros">
        <table id="tablaReporteIndividual">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nombre</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Tipo</th>
              <th>Observaciones</th>
              <th>Ubicación</th>
              <th>Lugar</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyReporteIndividual"></tbody>
        </table>
      </div>
      <!-- Sección para mostrar faltas del usuario en reporte individual -->
      <div class="mis-faltas-section-individual" id="reporteIndividualFaltasSection">
        <h4>Faltas del Usuario</h4>
        <table id="tablaReporteIndividualFaltas">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbodyReporteIndividualFaltas"></tbody>
        </table>
      </div>
      <div class="chart-container" style="margin-top: 20px;">
        <canvas id="reporteIndividualChart" width="400" height="200"></canvas>
      </div>
    </div>
    
    <!-- Modal para Añadir Registro Manual -->
    <div id="modalAddRegistro" class="modal">
      <div class="modal-content">
        <h3>Añadir Registro</h3>
        <div class="input-group">
          <label for="addDNI">DNI:</label>
          <input type="text" id="addDNI" maxlength="8" pattern="^\d{8}$">
        </div>
        <div class="input-group">
          <label for="addNombre">Nombre:</label>
          <input type="text" id="addNombre" readonly>
        </div>
        <div class="input-group">
          <label for="addTipo">Tipo:</label>
          <select id="addTipo">
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
          </select>
        </div>
        <div class="input-group">
          <label for="addHora">Hora:</label>
          <input type="time" id="addHora">
        </div>
        <!-- Nuevo: Observaciones -->
        <div class="input-group">
          <label for="addObs">Observaciones:</label>
          <textarea id="addObs" rows="3" placeholder="Opcional"></textarea>
        </div>
        <!-- Nuevo: Select Lugar -->
        <div class="input-group">
          <label for="addLugarSelect">Lugar:</label>
          <select id="addLugarSelect" onchange="onAddLugarChange(this.value)"></select>
        </div>
        <!-- Ubicación oculta, se llena según la geoballa elegida -->
        <input type="hidden" id="addUbicacion">
        <div class="actions-usuarios">
          <button class="btn-gray" onclick="cerrarModalAddRegistro()">
            <i class="fa-solid fa-xmark"></i> Cancelar
          </button>
          <button class="btn-blue" onclick="guardarRegistroManual()">
            <i class="fa-solid fa-floppy-disk"></i> Guardar
          </button>
        </div>
      </div>
    </div>
    
    <!-- Modal para Editar Registro Manual -->
    <div id="modalEditRegistro">
      <div class="modal-content">
        <h3>Editar Registro</h3>
        <!-- Guardamos el ID del registro en un input hidden -->
        <input type="hidden" id="editRegId">
        <div class="input-group">
          <label for="editTipo">Tipo:</label>
          <select id="editTipo">
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
          </select>
        </div>
        <div class="input-group">
          <label for="editHora">Hora:</label>
          <input type="time" id="editHora">
        </div>
        <div class="input-group">
          <label for="editObs">Observaciones:</label>
          <textarea id="editObs" rows="3" placeholder="Opcional"></textarea>
        </div>
        <div class="input-group">
          <label for="editLugarSelect">Lugar:</label>
          <select id="editLugarSelect" onchange="onEditLugarChange(this.value)"></select>
        </div>
        <input type="hidden" id="editUbicacion">
        <div class="actions-usuarios">
          <button class="btn-gray" onclick="cerrarModalEditRegistro()">
            <i class="fa-solid fa-xmark"></i> Cancelar
          </button>
          <button class="btn-blue" onclick="enviarActualizacionRegistro()">
            <i class="fa-solid fa-floppy-disk"></i> Actualizar
          </button>
        </div>
      </div>
    </div>
    
    <!-- Modal para Editar Falta -->
    <div id="modalEditFalta" class="modal">
      <div class="modal-content">
        <h3>Editar Falta</h3>
        <!-- Guardamos el ID de la falta en un input hidden -->
        <input type="hidden" id="editFaltaId">
        <div class="input-group">
          <label for="editFaltaObs">Observaciones:</label>
          <textarea id="editFaltaObs" rows="3" placeholder="Ingrese el motivo de la falta"></textarea>
        </div>
        <div class="actions-usuarios">
          <button class="btn-gray" onclick="cerrarModalEditFalta()">
            <i class="fa-solid fa-xmark"></i> Cancelar
          </button>
          <button class="btn-blue" onclick="enviarActualizacionFalta()">
            <i class="fa-solid fa-floppy-disk"></i> Actualizar
          </button>
        </div>
      </div>
    </div>
    
    <!-- Fancy Alert Modal (Mensaje) -->
    <div id="fancyAlertOverlay">
      <div id="fancyAlertBox">
        <div class="fancyAlertHeader">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <span id="fancyAlertTitle">¡Atención!</span>
        </div>
        <div id="fancyAlertMessage"></div>
        <button id="fancyAlertClose">Aceptar</button>
      </div>
    </div>
    
    <!-- Fancy Confirm Modal (Confirmación personalizada) -->
    <div id="fancyConfirmOverlay">
      <div id="fancyConfirmBox">
        <div class="fancyAlertHeader">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <span id="fancyConfirmTitle">Confirmar</span>
        </div>
        <div id="fancyConfirmMessage"></div>
        <div class="button-group-confirm">
          <button id="fancyConfirmYes">Sí</button>
          <button id="fancyConfirmNo">No</button>
        </div>
      </div>
    </div>
    
    <!-- Incluir Chart.js para el gráfico del Reporte Individual -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Incluir el script de Google Maps con tu API key -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4YhQYvvHu7g53Xf53jDHGleUJYVAt1cA&callback=initMap"></script>
    <script>
      /************** FUNCIONES GENERALES DE ERROR **************/
      function handleError(error) {
        console.error("Ocurrió un error:", error);
        showFancyAlert("Error: " + error.message);
      }
      
      /************** INICIALIZACIÓN Y CONFIGURACIÓN **************/
      let geoballasList = [];  // Lista de geoballas para usarlas en los selects
      let reporteIndividualData = [];  // Almacena los registros del reporte individual

      function inicializarPagina() {
        document.getElementById("anio").textContent = new Date().getFullYear();
        const iconoOjo = document.getElementById("iconoOjo");
        iconoOjo.addEventListener("click", togglePassword);
        verificarSesionActiva();
      }
      
      /************** CONTROL DE SESIÓN Y LOGIN **************/
      function verificarSesionActiva() {
        google.script.run
          .withSuccessHandler(function(estaActivo) {
            if (estaActivo) {
              document.getElementById("loginDiv").classList.remove("visible");
              document.getElementById("loginDiv").classList.add("hidden");
              setTimeout(() => {
                document.getElementById("loginDiv").style.display = "none";
                document.getElementById("mainContent").style.display = "block";
                document.getElementById("mainContent").classList.add("visible");
                obtenerNombreUsuario();
                obtenerNivelUsuario();
                cargarMarcacionesHoy();
              }, 300);
            } else {
              document.getElementById("loginDiv").classList.remove("hidden");
              document.getElementById("loginDiv").classList.add("visible");
              document.getElementById("mainContent").style.display = "none";
            }
          })
          .withFailureHandler(handleError)
          .validarSesionActiva();
      }
      
      function enviarLogin() {
        const loginBtn = document.getElementById("loginBtn");
        const spinner = document.getElementById("loginSpinner");
        loginBtn.disabled = true;
        spinner.style.display = "block";
        const usuario = document.getElementById("usuario").value;
        const contrasena = document.getElementById("contrasena").value;
        google.script.run
          .withSuccessHandler(function(esValido) {
            loginBtn.disabled = false;
            spinner.style.display = "none";
            if (esValido) {
              document.getElementById("loginDiv").classList.remove("visible");
              document.getElementById("loginDiv").classList.add("hidden");
              setTimeout(() => {
                document.getElementById("loginDiv").style.display = "none";
                document.getElementById("mainContent").style.display = "block";
                document.getElementById("mainContent").classList.add("visible");
                obtenerNombreUsuario();
                obtenerNivelUsuario();
                cargarMarcacionesHoy();
              }, 300);
            } else {
              showFancyAlert("Contraseña incorrecta.");
            }
          })
          .withFailureHandler(handleError)
          .validarLogin(usuario, contrasena);
      }
      
      function togglePassword() {
        const input = document.getElementById("contrasena");
        const icono = document.getElementById("iconoOjo");
        if (input.type === "password") {
          input.type = "text";
          icono.innerHTML = '<i class="fa-solid fa-eye"></i>';
        } else {
          input.type = "password";
          icono.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
        }
      }
      
      function obtenerNombreUsuario() {
        google.script.run
          .withSuccessHandler(function(nombre) {
            document.getElementById("bienvenida").innerText = "Bienvenido: " + nombre;
            document.getElementById("adminNombre").innerText = nombre;
          })
          .withFailureHandler(handleError)
          .obtenerNombreUsuario();
      }
      
      function obtenerNivelUsuario() {
        google.script.run
          .withSuccessHandler(function(nivel) {
            if (Number(nivel) === 1) {
              document.getElementById("adminBtn").style.display = "block";
            } else {
              document.getElementById("adminBtn").style.display = "none";
            }
          })
          .withFailureHandler(handleError)
          .obtenerNivelUsuario();
      }
      
      /************** MARCACIONES Y REGISTRO DE ASISTENCIA **************/
      function cargarMarcacionesHoy() {
        google.script.run
          .withSuccessHandler(function(registros) {
            const entradaDiv = document.getElementById("entradaLabel");
            const salidaDiv = document.getElementById("salidaLabel");
            entradaDiv.querySelector("span").textContent = "Entrada: --:--";
            salidaDiv.querySelector("span").textContent = "Salida: --:--";
            registros.forEach(r => {
              if (r.tipo === "Entrada") {
                entradaDiv.querySelector("span").textContent = `Entrada: ${r.fecha} ${r.hora}`;
              } else if (r.tipo === "Salida") {
                salidaDiv.querySelector("span").textContent = `Salida: ${r.fecha} ${r.hora}`;
              }
            });
          })
          .withFailureHandler(handleError)
          .obtenerMarcacionesHoy();
      }
      
      /************** FLUJO DE CÁMARA Y ASISTENCIA **************/
      let streamActivo = null;
      let ubicacionActual = "";
      let tipoEventoPendiente = null;
      
      function iniciarCamara(tipo) {
        tipoEventoPendiente = tipo;
        const video = document.getElementById("video");
        video.style.display = "block";
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
          .then(function(stream) {
            video.srcObject = stream;
            streamActivo = stream;
            mostrarBotonRegistrar();
            obtenerUbicacion();
          })
          .catch(function(error) {
            showFancyAlert("No se pudo acceder a la cámara: " + error.message);
          });
      }
      
      function mostrarBotonRegistrar() {
        if (!document.getElementById("btnRegistrar")) {
          const btn = document.createElement("button");
          btn.setAttribute("id", "btnRegistrar");
          btn.classList.add("btn-orange");
          btn.innerHTML = '<i class="fa-solid fa-check"></i> REGISTRAR';
          btn.onclick = function() {
            btn.disabled = true;
            capturarFotoYRegistrar();
          };
          document.getElementById("mainContent").appendChild(btn);
        }
      }
      
      function obtenerUbicacion() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              ubicacionActual = position.coords.latitude + ", " + position.coords.longitude;
            },
            function(error) {
              console.warn("Error GPS:", error.message);
              ubicacionActual = "No disponible";
            }
          );
        } else {
          ubicacionActual = "No soportado";
        }
      }
      
      function capturarFotoYRegistrar() {
        const video = document.getElementById("video");
        if (!video) return;
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        canvas.toBlob(function(blob) {
          const reader = new FileReader();
          reader.onloadend = function() {
            const base64Img = reader.result.split(',')[1];
            if (!ubicacionActual || ubicacionActual === "No disponible" || ubicacionActual === "No soportado") {
              showFancyAlert("No se pudo capturar la ubicación GPS. Asegúrate de tener el GPS activado.");
              stopCamera();
              return;
            }
            const tipoEvento = tipoEventoPendiente;
            if (!tipoEvento) {
              showFancyAlert("No se definió el tipo de evento (Entrada/Salida).");
              stopCamera();
              return;
            }
            google.script.run
              .withSuccessHandler(function(respuesta) {
                if (respuesta.permitido === true) {
                  verificarGeoballaYRegistrar(base64Img, ubicacionActual, tipoEvento);
                } else if (respuesta.permitido === "confirm") {
                  showFancyConfirm(
                    respuesta.mensaje,
                    function() {
                      verificarGeoballaYRegistrar(base64Img, ubicacionActual, tipoEvento);
                    },
                    function() {
                      stopCamera();
                    }
                  );
                } else {
                  showFancyAlert(respuesta.mensaje);
                  stopCamera();
                }
              })
              .withFailureHandler(handleError)
              .validarHorario(tipoEvento);
          };
          reader.readAsDataURL(blob);
        }, 'image/jpeg');
      }
      
      function verificarGeoballaYRegistrar(base64Img, ubicacion, tipoEvento) {
        google.script.run
          .withSuccessHandler(function(geoResult) {
            if (!geoResult || !geoResult.dentro) {
              const msg = geoResult
                ? `Estás a ${geoResult.distancia} metros de "${geoResult.lugar}".\nRadio permitido: ${geoResult.radio} m.\nNo puedes marcar asistencia.`
                : "No se encontró ninguna zona geográfica autorizada para marcar.";
              showFancyAlert(msg);
              stopCamera();
              return;
            }
            google.script.run
              .withSuccessHandler(function(resFinal) {
                showFancyAlert(resFinal.mensaje);
                stopCamera();
                cargarMarcacionesHoy();
              })
              .withFailureHandler(handleError)
              .subirYRegistrarAsistencia(base64Img, ubicacion, tipoEvento);
          })
          .withFailureHandler(handleError)
          .verificarGeoballa(ubicacion);
      }
      
      function stopCamera() {
        if (streamActivo) {
          streamActivo.getTracks().forEach(function(track) {
            track.stop();
          });
          streamActivo = null;
        }
        const video = document.getElementById("video");
        if (video) video.style.display = "none";
        const btnRegistrar = document.getElementById("btnRegistrar");
        if (btnRegistrar) btnRegistrar.remove();
      }
      
      /************** NUEVO APARTADO: REGISTRO PERSONAL DE ASISTENCIAS **************/
      function registroAsistencia() {
        mostrarRegistroPersonal();
      }
      
      function mostrarRegistroPersonal() {
        document.getElementById("mainContent").classList.remove("visible");
        document.getElementById("mainContent").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("mainContent").style.display = "none";
          document.getElementById("registroPersonal").style.display = "block";
          document.getElementById("registroPersonal").classList.add("visible");
          cargarRegistrosUsuario("", "");
          console.log("Llamando a cargarFaltasUsuario()...");
          cargarFaltasUsuario();
        }, 300);
      }
      
      function volverAlMenu() {
        document.getElementById("registroPersonal").classList.remove("visible");
        document.getElementById("registroPersonal").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("registroPersonal").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
          document.getElementById("mainContent").classList.add("visible");
        }, 300);
      }
      
      function filtrarRegistros() {
        var fechaInicio = document.getElementById("fechaInicio").value;
        var fechaFin = document.getElementById("fechaFin").value;
        if (!fechaInicio || !fechaFin) {
          showFancyAlert("Por favor, selecciona ambas fechas para filtrar.");
          return;
        }
        cargarRegistrosUsuario(fechaInicio, fechaFin);
      }
      
      function cargarRegistrosUsuario(fechaInicio, fechaFin) {
        google.script.run
          .withSuccessHandler(renderizarRegistros)
          .withFailureHandler(handleError)
          .obtenerRegistrosUsuario(fechaInicio, fechaFin);
      }
      
      function renderizarRegistros(registros) {
        const tbody = document.getElementById("tbodyRegistros");
        tbody.innerHTML = "";
        if (registros.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "No se encontraron registros.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        registros.forEach(reg => {
          const tr = document.createElement("tr");
          // Columna Foto
          const tdFoto = document.createElement("td");
          if (reg.foto) {
            const icono = document.createElement("i");
            icono.classList.add("fa-solid", "fa-image", "foto-icon");
            icono.title = "Ver foto";
            icono.onclick = function() { verFoto(reg.foto); };
            tdFoto.appendChild(icono);
          } else {
            tdFoto.textContent = "Sin foto";
          }
          tr.appendChild(tdFoto);
          // Nombre
          const tdNombre = document.createElement("td");
          tdNombre.textContent = reg.nombre || "";
          tr.appendChild(tdNombre);
          // Fecha
          const tdFecha = document.createElement("td");
          tdFecha.textContent = reg.fecha || "";
          tr.appendChild(tdFecha);
          // Tipo
          const tdTipo = document.createElement("td");
          tdTipo.textContent = reg.tipo || "";
          tr.appendChild(tdTipo);
          // Hora
          const tdHora = document.createElement("td");
          tdHora.textContent = reg.hora || "";
          tr.appendChild(tdHora);
          // Lugar
          const tdLugar = document.createElement("td");
          tdLugar.textContent = reg.lugar || "";
          tr.appendChild(tdLugar);
          tbody.appendChild(tr);
        });
      }
      
      // Funciones para cargar faltas del usuario
      function cargarFaltasUsuario() {
        google.script.run
          .withSuccessHandler(function(faltas) {
            console.log("Faltas recibidas:", faltas);
            renderizarFaltasUsuario(faltas);
          })
          .withFailureHandler(handleError)
          .obtenerFaltasPorUsuario();
      }
      
      function renderizarFaltasUsuario(faltas) {
        console.log("Faltas recibidas:", faltas);
        const tbody = document.getElementById("tbodyFaltasUsuario");
        if (!tbody) {
          console.error("No se encontró el elemento 'tbodyFaltasUsuario'");
          return;
        }
        tbody.innerHTML = "";
        if (!faltas || faltas.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "No se encontraron faltas.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        faltas.forEach(falta => {
          const tr = document.createElement("tr");
          // Formatear fecha (dd/MM/yyyy)
          const tdFecha = document.createElement("td");
          let fechaStr = falta.fecha;
          if (fechaStr) {
            try {
              let d = new Date(fechaStr);
              if (!isNaN(d)) {
                let dia = ("0" + d.getDate()).slice(-2);
                let mes = ("0" + (d.getMonth() + 1)).slice(-2);
                let anio = d.getFullYear();
                fechaStr = `${dia}/${mes}/${anio}`;
              }
            } catch(e) {
              console.error("Error al formatear la fecha:", e);
            }
          }
          tdFecha.textContent = fechaStr;
          const tdObs = document.createElement("td");
          tdObs.textContent = falta.observaciones || "";
          tr.appendChild(tdFecha);
          tr.appendChild(tdObs);
          tbody.appendChild(tr);
        });
      }
      
      /************** PANEL DE ADMINISTRACIÓN Y USUARIOS **************/
      function mostrarAdminPanel() {
        document.getElementById("mainContent").classList.remove("visible");
        document.getElementById("mainContent").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("loginDiv").style.display = "none";
          document.getElementById("mainContent").style.display = "none";
          document.getElementById("adminPanel").style.display = "block";
          document.getElementById("adminPanel").classList.add("visible");
          document.getElementById("usersSection").style.display = "none";
          document.getElementById("geoballasSection").style.display = "none";
          document.getElementById("reporteGeneralSection").style.display = "none";
          document.getElementById("reporteIndividualSection").style.display = "none";
          document.getElementById("faltasSection").style.display = "none";
        }, 300);
      }
      
      function volverAlAdminPanel() {
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("geoballasSection").style.display = "none";
        document.getElementById("reporteGeneralSection").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "none";
        document.getElementById("faltasSection").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminPanel").classList.add("visible");
      }
      
      function mostrarUsersSection() {
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("usersSection").style.display = "block";
        document.getElementById("geoballasSection").style.display = "none";
        document.getElementById("reporteGeneralSection").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "none";
        document.getElementById("faltasSection").style.display = "none";
        google.script.run
          .withSuccessHandler(renderizarUsuarios)
          .withFailureHandler(handleError)
          .obtenerListaUsuarios();
      }
      
      function mostrarGeoballas() {
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("geoballasSection").style.display = "block";
        document.getElementById("reporteGeneralSection").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "none";
        document.getElementById("faltasSection").style.display = "none";
        google.script.run
          .withSuccessHandler(renderizarGeoballas)
          .withFailureHandler(handleError)
          .obtenerGeoballas();
        if (typeof initMap === "function") {
          initMap();
        }
        setTimeout(function() {
          google.maps.event.trigger(map, "resize");
          map.setCenter({ lat: -8.109, lng: -79.021 });
        }, 100);
      }
      
      function mostrarFaltas() {
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("geoballasSection").style.display = "none";
        document.getElementById("reporteGeneralSection").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "none";
        document.getElementById("faltasSection").style.display = "block";
        // Aquí traemos TODAS las faltas (sin filtro) inicialmente:
        google.script.run
          .withSuccessHandler(renderizarFaltas)
          .withFailureHandler(handleError)
          .obtenerFaltas();
      }
      
      function renderizarUsuarios(lista) {
        const tbody = document.getElementById("tbodyUsuarios");
        tbody.innerHTML = "";
        lista.forEach(usuario => {
          const tr = document.createElement("tr");
          const tdAcciones = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.classList.add("btn-icon", "edit");
          btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
          btnEdit.onclick = () => confirmarEdicionUsuario(usuario);
          const btnDelete = document.createElement("button");
          btnDelete.classList.add("btn-icon", "delete");
          btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
          btnDelete.onclick = () => eliminarUsuario(usuario.dni);
          tdAcciones.appendChild(btnEdit);
          tdAcciones.appendChild(btnDelete);
          tr.appendChild(tdAcciones);
          const tdNombre = document.createElement("td");
          tdNombre.textContent = usuario.nombre || "";
          tr.appendChild(tdNombre);
          const tdDni = document.createElement("td");
          tdDni.textContent = usuario.dni || "";
          tr.appendChild(tdDni);
          const tdContra = document.createElement("td");
          tdContra.textContent = usuario.contrasena || "";
          tr.appendChild(tdContra);
          const tdArea = document.createElement("td");
          tdArea.textContent = usuario.area || "";
          tr.appendChild(tdArea);
          const tdCargo = document.createElement("td");
          tdCargo.textContent = usuario.cargo || "";
          tr.appendChild(tdCargo);
          const tdEmail = document.createElement("td");
          tdEmail.textContent = usuario.email || "";
          tr.appendChild(tdEmail);
          const tdNivel = document.createElement("td");
          tdNivel.textContent = usuario.nivel || 0;
          tr.appendChild(tdNivel);
          const tdHoras = document.createElement("td");
          tdHoras.textContent = usuario.horasExtras || 0;
          tr.appendChild(tdHoras);
          tbody.appendChild(tr);
        });
      }
      
      function renderizarGeoballas(geoballas) {
        geoballasList = geoballas; // Guardamos la lista para usarlas en <select>
        const tbody = document.getElementById("tbodyGeoballas");
        tbody.innerHTML = "";
        geoballas.forEach(geo => {
          const tr = document.createElement("tr");
          const tdLugar = document.createElement("td");
          tdLugar.textContent = geo.lugar || "";
          tr.appendChild(tdLugar);
          const tdUbicacion = document.createElement("td");
          tdUbicacion.textContent = geo.ubicacion || "";
          tr.appendChild(tdUbicacion);
          const tdRadio = document.createElement("td");
          tdRadio.textContent = geo.radio || "";
          tr.appendChild(tdRadio);
          const tdAcciones = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.classList.add("btn-icon", "edit");
          btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
          btnEdit.onclick = () => confirmarEdicionGeoballa(geo);
          const btnDelete = document.createElement("button");
          btnDelete.classList.add("btn-icon", "delete");
          btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
          btnDelete.onclick = () => eliminarGeoballa(geo.lugar);
          tdAcciones.appendChild(btnEdit);
          tdAcciones.appendChild(btnDelete);
          tr.appendChild(tdAcciones);
          tbody.appendChild(tr);
        });
        cargarGeoballasEnSelect("addLugarSelect");
        cargarGeoballasEnSelect("editLugarSelect");
      }
      
      function cargarGeoballasEnSelect(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = "";
        geoballasList.forEach(g => {
          const option = document.createElement("option");
          option.value = g.lugar;
          option.textContent = g.lugar;
          select.appendChild(option);
        });
      }
      
      function onAddLugarChange(lugarSel) {
        const geo = geoballasList.find(g => g.lugar === lugarSel);
        if (geo) {
          document.getElementById("addUbicacion").value = geo.ubicacion;
        }
      }
      
      function onEditLugarChange(lugarSel) {
        const geo = geoballasList.find(g => g.lugar === lugarSel);
        if (geo) {
          document.getElementById("editUbicacion").value = geo.ubicacion;
        }
      }
      
      function confirmarEdicionUsuario(usuario) {
        showFancyConfirm(
          `¿Está seguro de que desea editar al usuario con DNI: ${usuario.dni}?`,
          () => { editarUsuario(usuario); },
          () => { console.log("Edición cancelada"); }
        );
      }
      
      function confirmarEdicionGeoballa(geo) {
        showFancyConfirm(
          `¿Está seguro de que desea editar la geoballa para el lugar: ${geo.lugar}?`,
          () => { editarGeoballa(geo); },
          () => { console.log("Edición de geoballa cancelada"); }
        );
      }
      
      function editarUsuario(usuario) {
        document.getElementById("usuarioDni").value = usuario.dni;
        document.getElementById("nombreCompleto").value = usuario.nombre;
        document.getElementById("area").value = usuario.area;
        document.getElementById("cargo").value = usuario.cargo;
        document.getElementById("email").value = usuario.email;
        document.getElementById("contrasenaUsuario").value = usuario.contrasena;
        document.getElementById("nivel").value = usuario.nivel;
        document.getElementById("horasExtras").value = usuario.horasExtras;
      }
      
      function eliminarUsuario(dni) {
        showFancyConfirm(
          `¿Está seguro de que desea eliminar al usuario con DNI: ${dni}?\nEsta acción no se puede deshacer.`,
          () => {
            google.script.run
              .withSuccessHandler((exito) => {
                if (exito) { showFancyAlert("Usuario eliminado correctamente."); }
                else { showFancyAlert(`No se encontró el usuario con DNI: ${dni}.`); }
                google.script.run
                  .withSuccessHandler(renderizarUsuarios)
                  .withFailureHandler(handleError)
                  .obtenerListaUsuarios();
              })
              .withFailureHandler(handleError)
              .eliminarUsuario(dni);
          },
          () => { console.log("Eliminación cancelada"); }
        );
      }
      
      function editarGeoballa(geo) {
        document.getElementById("geoballaLugar").value = geo.lugar;
        document.getElementById("geoballaUbicacion").value = geo.ubicacion;
        document.getElementById("geoballaRadio").value = geo.radio;
        if (map) {
          var parts = geo.ubicacion.split(",");
          var lat = parseFloat(parts[0].trim());
          var lng = parseFloat(parts[1].trim());
          var newPos = { lat, lng };
          if (!marker) {
            marker = new google.maps.Marker({
              position: newPos,
              map: map,
              icon: { url: "https://i.imgur.com/tud5XMS.png", scaledSize: new google.maps.Size(32, 32) }
            });
          } else {
            marker.setPosition(newPos);
          }
          updateCircle(newPos);
          map.setCenter(newPos);
        }
      }
      
      function eliminarGeoballa(lugar) {
        showFancyConfirm(
          `¿Está seguro de que desea eliminar la geoballa para el lugar: ${lugar}?`,
          () => {
            google.script.run
              .withSuccessHandler(function(res) {
                showFancyAlert(res.mensaje);
                mostrarGeoballas();
              })
              .withFailureHandler(handleError)
              .eliminarGeoballa(lugar);
          },
          () => { console.log("Eliminación de geoballa cancelada"); }
        );
      }
      
      function guardarGeoballa() {
        const lugar = document.getElementById("geoballaLugar").value.trim();
        const ubicacion = document.getElementById("geoballaUbicacion").value.trim();
        const radio = document.getElementById("geoballaRadio").value.trim();
        if (!lugar || !ubicacion || !radio) {
          showFancyAlert("Por favor, complete todos los campos de la geoballa.");
          return;
        }
        const geoObj = { lugar, ubicacion, radio: parseFloat(radio) };
        google.script.run
          .withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje);
            mostrarGeoballas();
          })
          .withFailureHandler(handleError)
          .guardarGeoballa(geoObj);
      }
      
      function limpiarFormulario() {
        document.getElementById("usuarioDni").value = "";
        document.getElementById("nombreCompleto").value = "";
        document.getElementById("area").value = "";
        document.getElementById("cargo").value = "";
        document.getElementById("email").value = "";
        document.getElementById("contrasenaUsuario").value = "";
        document.getElementById("nivel").value = "";
        document.getElementById("horasExtras").value = "";
      }
      
      function guardarUsuario() {
        const dni = document.getElementById("usuarioDni").value.trim();
        const nombre = document.getElementById("nombreCompleto").value.trim();
        const area = document.getElementById("area").value.trim();
        const cargo = document.getElementById("cargo").value.trim();
        const email = document.getElementById("email").value.trim();
        const contrasena = document.getElementById("contrasenaUsuario").value.trim();
        const nivel = document.getElementById("nivel").value.trim();
        const horasExtras = document.getElementById("horasExtras").value.trim();
        if (!/^\d{8}$/.test(dni)) {
          showFancyAlert("El DNI debe ser un número de 8 dígitos.");
          return;
        }
        if (!/^\d{8}$/.test(contrasena)) {
          showFancyAlert("La contraseña debe tener exactamente 8 dígitos numéricos.");
          return;
        }
        const userObj = {
          dni,
          nombre,
          area,
          cargo,
          email,
          contrasena,
          nivel: parseInt(nivel, 10),
          horasExtras: parseInt(horasExtras, 10)
        };
        const guardarBtn = document.getElementById("guardarBtn");
        guardarBtn.disabled = true;
        google.script.run
          .withSuccessHandler(() => {
            showFancyAlert("Usuario guardado correctamente.");
            limpiarFormulario();
            google.script.run
              .withSuccessHandler(renderizarUsuarios)
              .withFailureHandler(handleError)
              .obtenerListaUsuarios();
            guardarBtn.disabled = false;
          })
          .withFailureHandler(function(err) {
            showFancyAlert("Error al guardar usuario: " + err.message);
            guardarBtn.disabled = false;
          })
          .guardarUsuarioEnHoja(userObj);
      }
      
      /************** CIERRE DE SESIÓN **************/
      function cerrarSesion() {
        google.script.run
          .withSuccessHandler(() => {
            document.getElementById("adminPanel").style.display = "none";
            document.getElementById("mainContent").style.display = "none";
            document.getElementById("registroPersonal").style.display = "none";
            document.getElementById("reporteGeneralSection").style.display = "none";
            document.getElementById("reporteIndividualSection").style.display = "none";
            document.getElementById("faltasSection").style.display = "none";
            document.getElementById("loginDiv").style.display = "block";
            document.getElementById("loginDiv").className = "login-box visible";
            document.getElementById("usuario").value = "";
            document.getElementById("contrasena").value = "";
          })
          .withFailureHandler(handleError)
          .cerrarSesion();
      }
      
      /************** FANCY ALERT y CONFIRM **************/
      function showFancyAlert(message) {
        const overlay = document.getElementById("fancyAlertOverlay");
        const msg = document.getElementById("fancyAlertMessage");
        msg.textContent = message;
        overlay.classList.add("active");
      }
      
      function closeFancyAlert() {
        const overlay = document.getElementById("fancyAlertOverlay");
        overlay.classList.remove("active");
      }
      
      document.getElementById("fancyAlertClose").addEventListener("click", closeFancyAlert);
      
      function showFancyConfirm(message, onYes, onNo) {
        const overlay = document.getElementById("fancyConfirmOverlay");
        const msg = document.getElementById("fancyConfirmMessage");
        msg.textContent = message;
        overlay.classList.add("active");
        const btnYes = document.getElementById("fancyConfirmYes");
        const btnNo = document.getElementById("fancyConfirmNo");
        btnYes.onclick = null;
        btnNo.onclick = null;
        btnYes.onclick = () => {
          overlay.classList.remove("active");
          if (typeof onYes === "function") onYes();
        };
        btnNo.onclick = () => {
          overlay.classList.remove("active");
          if (typeof onNo === "function") onNo();
        };
      }
      
      /************** ESTADÍSTICAS Y REPORTES **************/
      function mostrarEstadisticas() {
        document.getElementById("adminPanel").classList.remove("hidden");
        document.getElementById("adminPanel").classList.add("visible");
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("geoballasSection").style.display = "none";
        document.getElementById("reporteGeneralSection").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "none";
        document.getElementById("faltasSection").style.display = "none";
        google.script.run
          .withSuccessHandler(function(stats) {
            let mensaje = "Estadísticas generales:\n";
            mensaje += "Total Registros: " + stats.totalRegistros + "\n";
            mensaje += "Total Entradas: " + stats.totalEntradas + "\n";
            mensaje += "Total Salidas: " + stats.totalSalidas + "\n\n";
            mensaje += "Registros por Usuario:\n";
            for (let dni in stats.registrosPorUsuario) {
              mensaje += dni + ": " + stats.registrosPorUsuario[dni] + "\n";
            }
            showFancyAlert(mensaje);
          })
          .withFailureHandler(handleError)
          .obtenerEstadisticas();
      }
      
      function reporteGeneral() {
        document.getElementById("adminPanel").classList.remove("visible");
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("reporteGeneralSection").style.display = "block";
        setTimeout(() => {
          document.getElementById("reporteGeneralSection").classList.add("visible");
        }, 300);
        filtrarReporteGeneral();
      }
      
      function reporteIndividual() {
        document.getElementById("adminPanel").classList.remove("visible");
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("reporteIndividualSection").style.display = "block";
        setTimeout(() => {
          document.getElementById("reporteIndividualSection").classList.add("visible");
        }, 300);
        filtrarReporteIndividual();
      }
      
      /************** Funciones para el Reporte General **************/
      function filtrarReporteGeneral() {
        var fechaInicio = document.getElementById("rgFechaInicio").value;
        var fechaFin = document.getElementById("rgFechaFin").value;
        google.script.run
          .withSuccessHandler(renderizarReporteGeneral)
          .withFailureHandler(handleError)
          .obtenerRegistrosUsuario(fechaInicio, fechaFin);
      }
      
      function renderizarReporteGeneral(registros) {
        const tbody = document.getElementById("tbodyReporteGeneral");
        tbody.innerHTML = "";
        if (registros.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 9;
          td.textContent = "No se encontraron registros.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        registros.forEach(reg => {
          const tr = document.createElement("tr");
          // Columna Foto
          const tdFoto = document.createElement("td");
          if (reg.foto) {
            const btnFoto = document.createElement("button");
            btnFoto.classList.add("btn-gray");
            btnFoto.innerHTML = '<i class="fa-solid fa-image"></i>';
            btnFoto.onclick = function() { verFoto(reg.foto); };
            tdFoto.appendChild(btnFoto);
          } else {
            tdFoto.textContent = "Sin foto";
          }
          tr.appendChild(tdFoto);
          // Nombre
          const tdNombre = document.createElement("td");
          tdNombre.textContent = reg.nombre || "";
          tr.appendChild(tdNombre);
          // Fecha
          const tdFecha = document.createElement("td");
          tdFecha.textContent = reg.fecha || "";
          tr.appendChild(tdFecha);
          // Hora
          const tdHora = document.createElement("td");
          tdHora.textContent = reg.hora || "";
          tr.appendChild(tdHora);
          // Tipo
          const tdTipo = document.createElement("td");
          tdTipo.textContent = reg.tipo || "";
          tr.appendChild(tdTipo);
          // Observaciones
          const tdObs = document.createElement("td");
          tdObs.textContent = reg.observaciones || "";
          tr.appendChild(tdObs);
          // Ubicación
          const tdUbicacion = document.createElement("td");
          tdUbicacion.textContent = reg.ubicacion || "";
          tr.appendChild(tdUbicacion);
          // Lugar
          const tdLugar = document.createElement("td");
          tdLugar.textContent = reg.lugar || "";
          tr.appendChild(tdLugar);
          // Acciones
          const tdAcciones = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.classList.add("btn-orange");
          btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
          btnEdit.onclick = function() { editarRegistroManual(reg); };
          const btnDelete = document.createElement("button");
          btnDelete.classList.add("btn-red");
          btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
          btnDelete.onclick = function() { eliminarRegistroManual(reg.id); };
          tdAcciones.appendChild(btnEdit);
          tdAcciones.appendChild(btnDelete);
          tr.appendChild(tdAcciones);
          tbody.appendChild(tr);
        });
      }
      
      /************** Funciones para el Reporte Individual **************/
      function filtrarReporteIndividual() {
        var dni = document.getElementById("riDNI").value;
        var fechaInicio = document.getElementById("riFechaInicio").value;
        var fechaFin = document.getElementById("riFechaFin").value;
        var tipo = document.getElementById("riTipo").value;
        google.script.run
          .withSuccessHandler(renderizarReporteIndividual)
          .withFailureHandler(handleError)
          .obtenerReporteIndividual(dni, fechaInicio, fechaFin, tipo);
        // Cargar faltas del usuario consultado
        google.script.run
          .withSuccessHandler(renderizarReporteIndividualFaltas)
          .withFailureHandler(handleError)
          .obtenerFaltasPorUsuario(dni);
      }
      
      function renderizarReporteIndividual(registros) {
        reporteIndividualData = registros; // Guardamos para exportar
        const tbody = document.getElementById("tbodyReporteIndividual");
        tbody.innerHTML = "";
        if (registros.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 9;
          td.textContent = "No se encontraron registros.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          if (window.reporteIndividualChartInstance) { window.reporteIndividualChartInstance.destroy(); }
          return;
        }
        registros.forEach(reg => {
          const tr = document.createElement("tr");
          // Columna Foto
          const tdFoto = document.createElement("td");
          if (reg.foto) {
            const btnFoto = document.createElement("button");
            btnFoto.classList.add("btn-gray");
            btnFoto.innerHTML = '<i class="fa-solid fa-image"></i>';
            btnFoto.onclick = function() { verFoto(reg.foto); };
            tdFoto.appendChild(btnFoto);
          } else {
            tdFoto.textContent = "Sin foto";
          }
          tr.appendChild(tdFoto);
          // Nombre
          const tdNombre = document.createElement("td");
          tdNombre.textContent = reg.nombre || "";
          tr.appendChild(tdNombre);
          // Fecha
          const tdFecha = document.createElement("td");
          tdFecha.textContent = reg.fecha || "";
          tr.appendChild(tdFecha);
          // Hora
          const tdHora = document.createElement("td");
          tdHora.textContent = reg.hora || "";
          tr.appendChild(tdHora);
          // Tipo
          const tdTipo = document.createElement("td");
          tdTipo.textContent = reg.tipo || "";
          tr.appendChild(tdTipo);
          // Observaciones
          const tdObs = document.createElement("td");
          tdObs.textContent = reg.observaciones || "";
          tr.appendChild(tdObs);
          // Ubicación
          const tdUbicacion = document.createElement("td");
          tdUbicacion.textContent = reg.ubicacion || "";
          tr.appendChild(tdUbicacion);
          // Lugar
          const tdLugar = document.createElement("td");
          tdLugar.textContent = reg.lugar || "";
          tr.appendChild(tdLugar);
          // Acciones
          const tdAcciones = document.createElement("td");
          const btnEdit = document.createElement("button");
          btnEdit.classList.add("btn-orange");
          btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
          btnEdit.onclick = function() { editarRegistroManual(reg); };
          const btnDelete = document.createElement("button");
          btnDelete.classList.add("btn-red");
          btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
          btnDelete.onclick = function() { eliminarRegistroManual(reg.id); };
          tdAcciones.appendChild(btnEdit);
          tdAcciones.appendChild(btnDelete);
          tr.appendChild(tdAcciones);
          tbody.appendChild(tr);
        });
        crearChartReporteIndividual(registros);
      }
      
      function crearChartReporteIndividual(registros) {
        let countEntrada = registros.filter(r => r.tipo === "Entrada").length;
        let countSalida = registros.filter(r => r.tipo === "Salida").length;
        if (window.reporteIndividualChartInstance) {
          window.reporteIndividualChartInstance.destroy();
        }
        const ctx = document.getElementById("reporteIndividualChart").getContext('2d');
        window.reporteIndividualChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Entrada', 'Salida'],
            datasets: [{
              label: '# de Marcaciones',
              data: [countEntrada, countSalida],
              backgroundColor: ['rgba(229,57,53,0.6)', 'rgba(0,123,255,0.6)'],
              borderColor: ['rgba(229,57,53,1)', 'rgba(0,123,255,1)'],
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
      
      function renderizarReporteIndividualFaltas(faltas) {
        const tbody = document.getElementById("tbodyReporteIndividualFaltas");
        tbody.innerHTML = "";
        if (faltas.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "No se encontraron faltas para este usuario.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        faltas.forEach(falta => {
          const tr = document.createElement("tr");
          const tdFecha = document.createElement("td");
          tdFecha.textContent = falta.fecha;
          const tdObs = document.createElement("td");
          tdObs.textContent = falta.observaciones;
          tr.appendChild(tdFecha);
          tr.appendChild(tdObs);
          tbody.appendChild(tr);
        });
      }
      
      function exportarReporteIndividual() {
        if (reporteIndividualData.length === 0) {
          showFancyAlert("No hay datos para exportar.");
          return;
        }
        let csv = "DNI,Nombre,Fecha,Hora,Tipo,Observaciones,Ubicación,Lugar\n";
        reporteIndividualData.forEach(reg => {
          csv += [
            reg.dni || "",
            reg.nombre || "",
            reg.fecha || "",
            reg.hora || "",
            reg.tipo || "",
            reg.observaciones ? '"' + reg.observaciones.replace(/"/g, '""') + '"' : "",
            reg.ubicacion || "",
            reg.lugar || ""
          ].join(",") + "\n";
        });
        let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "reporte_individual.csv";
        link.click();
      }
      
      /************** Funciones para el Modal de Añadir Registro **************/
      function mostrarModalAddRegistro() {
        const now = new Date();
        let hora = now.toTimeString().slice(0,5);
        document.getElementById("addHora").value = hora;
        document.getElementById("addObs").value = "";
        if (geoballasList.length > 0) {
          document.getElementById("addLugarSelect").value = geoballasList[0].lugar;
          document.getElementById("addUbicacion").value = geoballasList[0].ubicacion;
        }
        document.getElementById("addDNI").value = "";
        document.getElementById("addNombre").value = "";
        document.getElementById("modalAddRegistro").style.display = "block";
      }
      
      function cerrarModalAddRegistro() {
        document.getElementById("modalAddRegistro").style.display = "none";
      }
      
      /************** Funciones para Editar Registro (Modal) **************/
      function editarRegistroManual(registro) {
        document.getElementById("editRegId").value = registro.id || "";
        document.getElementById("editTipo").value = registro.tipo || "Entrada";
        document.getElementById("editHora").value = registro.hora.slice(0,5);
        document.getElementById("editObs").value = registro.observaciones || "";
        if (registro.lugar) {
          document.getElementById("editLugarSelect").value = registro.lugar;
          const geo = geoballasList.find(g => g.lugar === registro.lugar);
          if (geo) {
            document.getElementById("editUbicacion").value = geo.ubicacion;
          } else {
            document.getElementById("editUbicacion").value = "";
          }
        }
        document.getElementById("modalEditRegistro").style.display = "block";
      }
      
      function cerrarModalEditRegistro() {
        document.getElementById("modalEditRegistro").style.display = "none";
      }
      
      function enviarActualizacionRegistro() {
        const regId = document.getElementById("editRegId").value;
        const tipo = document.getElementById("editTipo").value;
        const hora = document.getElementById("editHora").value;
        const obs = document.getElementById("editObs").value.trim();
        const lugar = document.getElementById("editLugarSelect").value;
        const ubicacion = document.getElementById("editUbicacion").value;
        if (!regId) {
          showFancyAlert("No se encontró el ID del registro a editar.");
          return;
        }
        const registroEditado = {
          id: regId,
          tipo: tipo,
          hora: hora,
          observaciones: obs,
          lugar: lugar,
          ubicacion: ubicacion
        };
        google.script.run
          .withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje || "Registro actualizado.");
            cerrarModalEditRegistro();
            filtrarReporteGeneral();
          })
          .withFailureHandler(handleError)
          .actualizarRegistroManual(registroEditado);
      }
      
      function eliminarRegistroManual(registroId) {
        showFancyConfirm(
          "¿Está seguro de eliminar este registro?",
          function() {
            google.script.run
              .withSuccessHandler(function(res) {
                showFancyAlert(res.mensaje || "Registro eliminado.");
                filtrarReporteGeneral();
              })
              .withFailureHandler(handleError)
              .eliminarRegistroManual(registroId);
          },
          function() { console.log("Eliminación cancelada"); }
        );
      }
      
      /************** Funciones para Editar Falta (Modal) **************/
      function editarFalta(falta) {
        document.getElementById("editFaltaId").value = falta.id;
        document.getElementById("editFaltaObs").value = falta.observaciones || "";
        document.getElementById("modalEditFalta").style.display = "block";
      }
      
      function cerrarModalEditFalta() {
        document.getElementById("modalEditFalta").style.display = "none";
      }
      
      function enviarActualizacionFalta() {
        const faltaId = document.getElementById("editFaltaId").value;
        const obs = document.getElementById("editFaltaObs").value.trim();
        if (!faltaId) {
          showFancyAlert("No se encontró el ID de la falta.");
          return;
        }
        google.script.run
          .withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje || "Falta actualizada.");
            cerrarModalEditFalta();
            mostrarFaltas();
          })
          .withFailureHandler(handleError)
          .actualizarFalta(faltaId, obs);
      }
      
      /************** Funciones para el Mapa de Geoballas **************/
      var map;
      var marker;
      var circle;
      
      function updateCircle(center) {
        var radioInput = document.getElementById("geoballaRadio").value;
        var radio = parseFloat(radioInput);
        if (isNaN(radio)) radio = 50;
        if (!circle) {
          circle = new google.maps.Circle({
            map: map,
            center: center,
            radius: radio,
            fillColor: "#FF0000",
            fillOpacity: 0.2,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2
          });
        } else {
          circle.setCenter(center);
          circle.setRadius(radio);
        }
      }
      
      function initMap() {
        const defaultLatLng = { lat: -8.109, lng: -79.021 };
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLatLng,
          zoom: 15,
        });
        marker = new google.maps.Marker({
          position: defaultLatLng,
          map: map,
          icon: {
            url: "https://i.imgur.com/tud5XMS.png",
            scaledSize: new google.maps.Size(32, 32)
          }
        });
        updateCircle(defaultLatLng);
        map.addListener("click", (e) => {
          const lat = e.latLng.lat();
          const lng = e.latLng.lng();
          const newPos = { lat, lng };
          if (!marker) {
            marker = new google.maps.Marker({
              position: newPos,
              map: map,
              icon: {
                url: "https://i.imgur.com/tud5XMS.png",
                scaledSize: new google.maps.Size(32, 32)
              }
            });
          } else {
            marker.setPosition(newPos);
          }
          updateCircle(newPos);
          document.getElementById("geoballaUbicacion").value = lat + "," + lng;
        });
      }
      
      /************** Funciones para cargar faltas del Usuario **************/
      function cargarReporteIndividualFaltas(dni) {
        google.script.run
          .withSuccessHandler(renderizarReporteIndividualFaltas)
          .withFailureHandler(handleError)
          .obtenerFaltasPorUsuario(dni);
      }
      
      function renderizarReporteIndividualFaltas(faltas) {
        const tbody = document.getElementById("tbodyReporteIndividualFaltas");
        tbody.innerHTML = "";
        if (faltas.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "No se encontraron faltas para este usuario.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        faltas.forEach(falta => {
          const tr = document.createElement("tr");
          const tdFecha = document.createElement("td");
          tdFecha.textContent = falta.fecha;
          const tdObs = document.createElement("td");
          tdObs.textContent = falta.observaciones;
          tr.appendChild(tdFecha);
          tr.appendChild(tdObs);
          tbody.appendChild(tr);
        });
      }
      
      /************** EXPORTAR REPORTE INDIVIDUAL **************/
      function exportarReporteIndividual() {
        if (reporteIndividualData.length === 0) {
          showFancyAlert("No hay datos para exportar.");
          return;
        }
        let csv = "DNI,Nombre,Fecha,Hora,Tipo,Observaciones,Ubicación,Lugar\n";
        reporteIndividualData.forEach(reg => {
          csv += [
            reg.dni || "",
            reg.nombre || "",
            reg.fecha || "",
            reg.hora || "",
            reg.tipo || "",
            reg.observaciones ? '"' + reg.observaciones.replace(/"/g, '""') + '"' : "",
            reg.ubicacion || "",
            reg.lugar || ""
          ].join(",") + "\n";
        });
        let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "reporte_individual.csv";
        link.click();
      }
      
      /************** Funciones para el Modal de Añadir Registro **************/
      function mostrarModalAddRegistro() {
        const now = new Date();
        let hora = now.toTimeString().slice(0,5);
        document.getElementById("addHora").value = hora;
        document.getElementById("addObs").value = "";
        if (geoballasList.length > 0) {
          document.getElementById("addLugarSelect").value = geoballasList[0].lugar;
          document.getElementById("addUbicacion").value = geoballasList[0].ubicacion;
        }
        document.getElementById("addDNI").value = "";
        document.getElementById("addNombre").value = "";
        document.getElementById("modalAddRegistro").style.display = "block";
      }
      
      function cerrarModalAddRegistro() {
        document.getElementById("modalAddRegistro").style.display = "none";
      }
      
      /************** Funciones para Editar Registro (Modal) **************/
      function editarRegistroManual(registro) {
        document.getElementById("editRegId").value = registro.id || "";
        document.getElementById("editTipo").value = registro.tipo || "Entrada";
        document.getElementById("editHora").value = registro.hora.slice(0,5);
        document.getElementById("editObs").value = registro.observaciones || "";
        if (registro.lugar) {
          document.getElementById("editLugarSelect").value = registro.lugar;
          const geo = geoballasList.find(g => g.lugar === registro.lugar);
          if (geo) {
            document.getElementById("editUbicacion").value = geo.ubicacion;
          } else {
            document.getElementById("editUbicacion").value = "";
          }
        }
        document.getElementById("modalEditRegistro").style.display = "block";
      }
      
      function cerrarModalEditRegistro() {
        document.getElementById("modalEditRegistro").style.display = "none";
      }
      
      function enviarActualizacionRegistro() {
        const regId = document.getElementById("editRegId").value;
        const tipo = document.getElementById("editTipo").value;
        const hora = document.getElementById("editHora").value;
        const obs = document.getElementById("editObs").value.trim();
        const lugar = document.getElementById("editLugarSelect").value;
        const ubicacion = document.getElementById("editUbicacion").value;
        if (!regId) {
          showFancyAlert("No se encontró el ID del registro a editar.");
          return;
        }
        const registroEditado = {
          id: regId,
          tipo: tipo,
          hora: hora,
          observaciones: obs,
          lugar: lugar,
          ubicacion: ubicacion
        };
        google.script.run
          .withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje || "Registro actualizado.");
            cerrarModalEditRegistro();
            filtrarReporteGeneral();
          })
          .withFailureHandler(handleError)
          .actualizarRegistroManual(registroEditado);
      }
      
      function eliminarRegistroManual(registroId) {
        showFancyConfirm(
          "¿Está seguro de eliminar este registro?",
          function() {
            google.script.run
              .withSuccessHandler(function(res) {
                showFancyAlert(res.mensaje || "Registro eliminado.");
                filtrarReporteGeneral();
              })
              .withFailureHandler(handleError)
              .eliminarRegistroManual(registroId);
          },
          function() { console.log("Eliminación cancelada"); }
        );
      }
      
      /************** Funciones para Editar Falta (Modal) **************/
      function editarFalta(falta) {
        document.getElementById("editFaltaId").value = falta.id;
        document.getElementById("editFaltaObs").value = falta.observaciones || "";
        document.getElementById("modalEditFalta").style.display = "block";
      }
      
      function cerrarModalEditFalta() {
        document.getElementById("modalEditFalta").style.display = "none";
      }
      
      function enviarActualizacionFalta() {
        const faltaId = document.getElementById("editFaltaId").value;
        const obs = document.getElementById("editFaltaObs").value.trim();
        if (!faltaId) {
          showFancyAlert("No se encontró el ID de la falta.");
          return;
        }
        google.script.run
          .withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje || "Falta actualizada.");
            cerrarModalEditFalta();
            mostrarFaltas();
          })
          .withFailureHandler(handleError)
          .actualizarFalta(faltaId, obs);
      }
      
      /************** Funciones para el Mapa de Geoballas **************/
      var map;
      var marker;
      var circle;
      
      function updateCircle(center) {
        var radioInput = document.getElementById("geoballaRadio").value;
        var radio = parseFloat(radioInput);
        if (isNaN(radio)) radio = 50;
        if (!circle) {
          circle = new google.maps.Circle({
            map: map,
            center: center,
            radius: radio,
            fillColor: "#FF0000",
            fillOpacity: 0.2,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2
          });
        } else {
          circle.setCenter(center);
          circle.setRadius(radio);
        }
      }
      
      function initMap() {
        const defaultLatLng = { lat: -8.109, lng: -79.021 };
        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLatLng,
          zoom: 15,
        });
        marker = new google.maps.Marker({
          position: defaultLatLng,
          map: map,
          icon: {
            url: "https://i.imgur.com/tud5XMS.png",
            scaledSize: new google.maps.Size(32, 32)
          }
        });
        updateCircle(defaultLatLng);
        map.addListener("click", (e) => {
          const lat = e.latLng.lat();
          const lng = e.latLng.lng();
          const newPos = { lat, lng };
          if (!marker) {
            marker = new google.maps.Marker({
              position: newPos,
              map: map,
              icon: {
                url: "https://i.imgur.com/tud5XMS.png",
                scaledSize: new google.maps.Size(32, 32)
              }
            });
          } else {
            marker.setPosition(newPos);
          }
          updateCircle(newPos);
          document.getElementById("geoballaUbicacion").value = lat + "," + lng;
        });
      }
      
      /************** Funciones para cargar faltas del Usuario (Reporte Individual) **************/
      function cargarReporteIndividualFaltas(dni) {
        google.script.run
          .withSuccessHandler(renderizarReporteIndividualFaltas)
          .withFailureHandler(handleError)
          .obtenerFaltasPorUsuario(dni);
      }
      
      function renderizarReporteIndividualFaltas(faltas) {
        const tbody = document.getElementById("tbodyReporteIndividualFaltas");
        tbody.innerHTML = "";
        if (faltas.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 2;
          td.textContent = "No se encontraron faltas para este usuario.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        faltas.forEach(falta => {
          const tr = document.createElement("tr");
          const tdFecha = document.createElement("td");
          tdFecha.textContent = falta.fecha;
          const tdObs = document.createElement("td");
          tdObs.textContent = falta.observaciones;
          tr.appendChild(tdFecha);
          tr.appendChild(tdObs);
          tbody.appendChild(tr);
        });
      }
      
      /************** EXPORTAR REPORTE INDIVIDUAL **************/
      function exportarReporteIndividual() {
        if (reporteIndividualData.length === 0) {
          showFancyAlert("No hay datos para exportar.");
          return;
        }
        let csv = "DNI,Nombre,Fecha,Hora,Tipo,Observaciones,Ubicación,Lugar\n";
        reporteIndividualData.forEach(reg => {
          csv += [
            reg.dni || "",
            reg.nombre || "",
            reg.fecha || "",
            reg.hora || "",
            reg.tipo || "",
            reg.observaciones ? '"' + reg.observaciones.replace(/"/g, '""') + '"' : "",
            reg.ubicacion || "",
            reg.lugar || ""
          ].join(",") + "\n";
        });
        let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "reporte_individual.csv";
        link.click();
      }
      
      /************** Funciones para el Modal de Añadir Registro **************/
      function mostrarModalAddRegistro() {
        const now = new Date();
        let hora = now.toTimeString().slice(0,5);
        document.getElementById("addHora").value = hora;
        document.getElementById("addObs").value = "";
        if (geoballasList.length > 0) {
          document.getElementById("addLugarSelect").value = geoballasList[0].lugar;
          document.getElementById("addUbicacion").value = geoballasList[0].ubicacion;
        }
        document.getElementById("addDNI").value = "";
        document.getElementById("addNombre").value = "";
        document.getElementById("modalAddRegistro").style.display = "block";
      }
      
      function cerrarModalAddRegistro() {
        document.getElementById("modalAddRegistro").style.display = "none";
      }
      
      /************** Funciones de Fancy Alert y Fancy Confirm **************/
      function showFancyAlert(message) {
        const overlay = document.getElementById("fancyAlertOverlay");
        const msg = document.getElementById("fancyAlertMessage");
        msg.textContent = message;
        overlay.classList.add("active");
      }
      
      function closeFancyAlert() {
        const overlay = document.getElementById("fancyAlertOverlay");
        overlay.classList.remove("active");
      }
      
      document.getElementById("fancyAlertClose").addEventListener("click", closeFancyAlert);
      
      function showFancyConfirm(message, onYes, onNo) {
        const overlay = document.getElementById("fancyConfirmOverlay");
        const msg = document.getElementById("fancyConfirmMessage");
        msg.textContent = message;
        overlay.classList.add("active");
        const btnYes = document.getElementById("fancyConfirmYes");
        const btnNo = document.getElementById("fancyConfirmNo");
        btnYes.onclick = null;
        btnNo.onclick = null;
        btnYes.onclick = () => {
          overlay.classList.remove("active");
          if (typeof onYes === "function") onYes();
        };
        btnNo.onclick = () => {
          overlay.classList.remove("active");
          if (typeof onNo === "function") onNo();
        };
      }
      
      /************** NUEVA FUNCIÓN: Filtrar Faltas en el Panel Admin **************/
      function filtrarFaltasAdmin() {
        const fechaInicio = document.getElementById("fFechaInicio").value;
        const fechaFin = document.getElementById("fFechaFin").value;
        if (!fechaInicio || !fechaFin) {
          showFancyAlert("Por favor, selecciona ambas fechas para filtrar las faltas.");
          return;
        }
        google.script.run
          .withSuccessHandler(renderizarFaltas)
          .withFailureHandler(handleError)
          .obtenerFaltasPorFechas(fechaInicio, fechaFin);
      }
      
      function renderizarFaltas(resultado) {
        // Si se devuelve un objeto de error, mostrar mensaje
        if (resultado && resultado.error) {
          showFancyAlert(resultado.mensaje);
          return;
        }
        // Se asume que "resultado" es un arreglo de faltas filtradas
        const faltas = resultado;
        const tbody = document.getElementById("tbodyFaltas");
        tbody.innerHTML = "";
        if (faltas.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.textContent = "No se encontraron faltas en este rango de fechas.";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }
        faltas.forEach(falta => {
          const tr = document.createElement("tr");
          const tdDni = document.createElement("td");
          tdDni.textContent = falta.dni;
          const tdNombre = document.createElement("td");
          tdNombre.textContent = falta.nombre;
          const tdFecha = document.createElement("td");
          tdFecha.textContent = falta.fecha;
          const tdObs = document.createElement("td");
          tdObs.textContent = falta.observaciones;
          const tdAcciones = document.createElement("td");
          // Ejemplo: botón para editar la falta
          const btnEditar = document.createElement("button");
          btnEditar.textContent = "Editar";
          btnEditar.classList.add("btn-orange");
          btnEditar.onclick = () => editarFalta(falta);
          // Y botón para eliminar la falta (si tienes la función "eliminarFalta")
          const btnEliminar = document.createElement("button");
          btnEliminar.textContent = "Eliminar";
          btnEliminar.classList.add("btn-red");
          btnEliminar.onclick = () => eliminarFalta(falta.id);
          tdAcciones.appendChild(btnEditar);
          tdAcciones.appendChild(btnEliminar);
          
          tr.appendChild(tdDni);
          tr.appendChild(tdNombre);
          tr.appendChild(tdFecha);
          tr.appendChild(tdObs);
          tr.appendChild(tdAcciones);
          tbody.appendChild(tr);
        });
      }
      
      /************** Función placeholder para verFoto() **************/
      function verFoto(url) {
        alert("URL de la foto: " + url);
      }
    </script>
  </body>
</html>


