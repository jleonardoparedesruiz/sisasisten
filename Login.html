<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Ajuste para m√≥viles -->
  <meta name="viewport" content="width=device-width, initial-scale=1.2, maximum-scale=1.2">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* ==============================
       1. Reset y Estilos Generales
       ============================== */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, #ece9e6, #ffffff);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex; 
      justify-content: center; 
      align-items: center; 
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* ==============================
       2. Transiciones y Estados
       ============================== */
    .hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .visible {
      opacity: 1;
      pointer-events: auto;
      transition: opacity 0.3s ease;
    }
    
    /* ==============================
       3. Contenedores: Login, Marcaci√≥n, Panel Admin
       ============================== */
    .login-box, .marcacion-box, .admin-panel {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(229,57,53,0.3);
      width: 90%;
      max-width: 400px;
      text-align: center;
      margin: 40px auto;
    }
    .admin-panel {
      max-width: 1100px;
    }
    .logo {
      text-align: center;
      margin-bottom: 10px;
    }
    .logo img {
      max-width: 150px;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    
    /* ==============================
       4. Inputs, Botones y Spinner
       ============================== */
    .input-group {
      position: relative;
      margin: 10px 0;
      width: 100%;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      padding: 10px 35px;
      border: 2px solid #ddd;
      border-radius: 5px;
      outline: none;
      box-sizing: border-box;
    }
    input:focus {
      border-color: #e53935;
    }
    .input-group i {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }
    .input-group .fa-user,
    .input-group .fa-key {
      left: 10px;
    }
    .ver-contrase√±a {
      right: 10px;
      cursor: pointer;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
    }
    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: filter 0.3s;
      margin-top: 10px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      filter: brightness(0.9);
    }
    .btn-red { background: #e53935; }
    .btn-blue { background: #007bff; }
    .btn-gray { background: #555; }
    .btn-orange { background: #f0ad4e; }
    .mensaje { color: red; margin-top: 10px; }
    footer { color: #888; font-size: 12px; margin-top: 15px; }
    .spinner {
      display: none;
      margin: 10px auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #e53935;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ==============================
       5. Secci√≥n de Marcaci√≥n (Usuarios)
       ============================== */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    #bienvenida {
      font-weight: bold;
      margin: 15px 0;
      color: #333;
    }
    video {
      width: 100%;
      margin-top: 10px;
      border-radius: 8px;
      display: none;
      max-height: 300px;
    }
    
    /* Etiquetas para Entrada y Salida */
    .marcacion-labels {
      margin: 20px 0;
    }
    .entrada-label, .salida-label {
      padding: 10px;
      border-radius: 5px;
      margin: 5px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .entrada-label {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 5px solid #0c5460;
    }
    .salida-label {
      background: #d4edda;
      color: #155724;
      border-left: 5px solid #155724;
    }
    .entrada-label i, .salida-label i {
      font-size: 18px;
    }
    
    /* ==============================
       6. Panel de Administraci√≥n
       ============================== */
    .admin-navbar {
      background-color: #e53935;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .admin-navbar .logo-admin {
      font-size: 20px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .admin-navbar .menu-admin {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .admin-navbar .menu-admin a {
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    .admin-navbar .menu-admin a:hover {
      opacity: 0.8;
    }
    .admin-panel {
      display: none;
      background: #ffffff;
      margin: 60px auto 20px auto;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(229,57,53,0.3);
      width: 90%;
      max-width: 1100px;
      overflow: hidden;
    }
    .admin-panel .container-admin {
      padding: 20px;
    }
    .admin-panel h3 {
      margin: 0;
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    
    /* ==============================
       7. Secci√≥n Usuarios en Admin
       ============================== */
    .users-section {
      display: none;
      padding: 20px;
    }
    .users-section h4 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
    }
    .form-usuarios {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-usuarios .row-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-usuarios label {
      font-size: 13px;
      color: #333;
      margin-bottom: 5px;
      display: block;
    }
    .form-usuarios input {
      width: 100%;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      box-sizing: border-box;
    }
    .actions-usuarios {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .actions-usuarios button {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #fff;
      font-size: 14px;
    }
    .btn-clean { background-color: #888; }
    .btn-save { background-color: #e53935; }
    
    /* ==============================
       8. Tabla de Usuarios
       ============================== */
    .tabla-usuarios-container {
      width: 100%;
      overflow-x: auto;
    }
    .tabla-usuarios {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      table-layout: auto;
    }
    .tabla-usuarios thead {
      background-color: #e53935;
      color: #fff;
    }
    .tabla-usuarios th, .tabla-usuarios td {
      padding: 10px;
      font-size: 13px;
      text-align: left;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    /* Columna Acciones */
    .tabla-usuarios th:nth-child(1),
    .tabla-usuarios td:nth-child(1) {
      min-width: 90px;
    }
    .tabla-usuarios tbody tr:hover {
      background-color: #f5f5f5;
    }
    .tabla-usuarios .btn-icon {
      display: inline-block;
      vertical-align: middle;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 16px;
      margin-right: 4px;
    }
    .tabla-usuarios .btn-icon:last-child {
      margin-right: 0;
    }
    .tabla-usuarios .btn-icon.edit {
      color: #007bff;
    }
    .tabla-usuarios .btn-icon.delete {
      color: #e53935;
    }
    
    /* ==============================
       9. Fancy Alert Modal (Mensaje)
       ============================== */
    #fancyAlertOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #fancyAlertOverlay.active {
      display: flex;
      opacity: 1;
    }
    #fancyAlertBox {
      background: #fff;
      border-radius: 8px;
      padding: 20px 25px;
      width: 90%;
      max-width: 350px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      transform: translateY(-30px);
      transition: transform 0.3s;
    }
    #fancyAlertOverlay.active #fancyAlertBox {
      transform: translateY(0);
    }
    .fancyAlertHeader {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      color: #e53935;
      margin-bottom: 15px;
      justify-content: center;
    }
    .fancyAlertHeader i {
      color: #e53935;
      font-size: 22px;
    }
    #fancyAlertTitle {
      font-weight: bold;
    }
    #fancyAlertMessage {
      font-size: 14px;
      color: #333;
      margin-bottom: 15px;
      white-space: pre-wrap;
    }
    #fancyAlertClose {
      display: block;
      margin: 20px auto 0 auto;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
    }
    #fancyAlertClose:hover {
      filter: brightness(0.9);
    }
    
    /* ==============================
       10. Fancy Confirm Modal (Confirmaci√≥n personalizada)
       ============================== */
    #fancyConfirmOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #fancyConfirmOverlay.active {
      display: flex;
      opacity: 1;
    }
    #fancyConfirmBox {
      background: #fff;
      border-radius: 8px;
      padding: 20px 25px;
      width: 90%;
      max-width: 350px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      transform: translateY(-30px);
      transition: transform 0.3s;
    }
    #fancyConfirmOverlay.active #fancyConfirmBox {
      transform: translateY(0);
    }
    .button-group-confirm {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .button-group-confirm button {
      background: #e53935;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      min-width: 80px;
    }
    .button-group-confirm button:hover {
      filter: brightness(0.9);
    }
    
    /* ==============================
       11. Secci√≥n Geoballas (Administraci√≥n)
       ============================== */
    .geoballas-section {
      display: none;
      padding: 20px;
      text-align: left;
    }
    .geoballas-section h4 {
      margin-top: 0;
      font-size: 18px;
      color: #333;
      margin-bottom: 10px;
    }
    .geoballas-section table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    .geoballas-section th, .geoballas-section td {
      padding: 8px;
      border: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
    }
    .geoballas-section .btn-icon {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin-right: 4px;
    }
    .geoballas-section .btn-icon.edit {
  color: #007bff; /* Azul, puedes cambiarlo */
}

.geoballas-section .btn-icon.delete {
  color: #e53935; /* Rojo, puedes cambiarlo */
}
.geoballas-section .btn-icon:hover {
  opacity: 0.8; /* Efecto de oscurecer un poco al pasar el mouse */
}
    /* Contenedor para el mapa interactivo */
    #map {
      width: 100%;
      height: 400px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    
    /* ==============================
       12. Media Queries
       ============================== */
    @media (max-width: 800px) {
      .form-usuarios .row-fields {
        flex-direction: column;
      }
      .form-usuarios .row-fields > div {
        min-width: auto;
        width: 100%;
      }
    }
    @media (max-width: 600px) {
      .tabla-usuarios th, .tabla-usuarios td {
        font-size: 12px;
      }
      .login-box, .marcacion-box {
        width: 95%;
        padding: 20px;
        margin-top: 20px;
      }
      .logo img {
        max-width: 120px;
      }
      .button-group {
        flex-direction: column;
      }
      .admin-navbar .menu-admin {
        gap: 10px;
      }
    }
  </style>
</head>

<body onload="inicializarPagina()">
  <!-- LOGIN -->
  <div class="login-box visible" id="loginDiv">
    <div class="logo">
      <img src="https://i.imgur.com/tud5XMS.png" alt="SOLINPA Logo">
    </div>
    <h2><i class="fa-solid fa-lock"></i> Inicia Sesi√≥n</h2>
    <h3>Sistema de Asistencia SOLINPA</h3>

    <div class="input-group">
      <i class="fa-solid fa-user"></i>
      <input type="text" id="usuario" placeholder="DNI" required maxlength="8">
    </div>

    <div class="input-group">
      <i class="fa-solid fa-key"></i>
      <input type="password" id="contrasena" placeholder="Clave" required>
      <span class="ver-contrase√±a" id="iconoOjo">
        <i class="fa-solid fa-eye-slash"></i>
      </span>
    </div>

    <button class="btn-red" id="loginBtn" onclick="enviarLogin()">
      <i class="fa-solid fa-right-to-bracket"></i> Entrar
    </button>
    <div class="spinner" id="loginSpinner"></div>
    <div class="mensaje" id="mensaje"></div>

    <footer>¬© <span id="anio"></span> - SOLINPA E.I.R.L.</footer>
  </div>

  <!-- MARCACI√ìN (Usuarios) -->
  <div class="marcacion-box hidden" id="mainContent">
    <div class="logo">
      <img src="https://i.imgur.com/tud5XMS.png" alt="SOLINPA Logo">
    </div>
    <h3>Marque su asistencia</h3>
    <div id="bienvenida">Bienvenido: Usuario</div>

    <div class="button-group">
      <button class="btn-red" id="registroBtn" onclick="registroAsistencia()">
        <i class="fa-solid fa-file-lines"></i> Ir a mi Registro de Asistencias
      </button>
      <button class="btn-blue" id="adminBtn" style="display:none;" onclick="mostrarAdminPanel()">
        <i class="fa-solid fa-user-gear"></i> Ir a Panel de Administrador
      </button>
      <button class="btn-gray" onclick="cerrarSesion()">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
      </button>
    </div>

    <!-- Etiquetas para Entrada y Salida -->
    <div class="marcacion-labels">
      <div class="entrada-label" id="entradaLabel">
        <i class="fa-solid fa-door-open"></i>
        <span>Entrada: --:--</span>
      </div>
      <div class="salida-label" id="salidaLabel">
        <i class="fa-solid fa-door-closed"></i>
        <span>Salida: --:--</span>
      </div>
    </div>

    <button class="btn-orange" onclick="automatizarAsistencia()">
      <i class="fa-solid fa-camera"></i> Activar C√°mara
    </button>
    <video id="video" autoplay playsinline></video>
    <div class="mensaje" id="mensajeEvento"></div>
  </div>

  <!-- PANEL DE ADMINISTRACI√ìN -->
  <div class="admin-panel hidden" id="adminPanel">
    <div class="admin-navbar">
      <div class="logo-admin">SOLINPA</div>
      <div class="menu-admin">
        <a onclick="reporteGeneral()">Reporte General</a>
        <a onclick="reporteIndividual()">Reporte Individual</a>
        <a onclick="mostrarEstadisticas()">Estad√≠sticas</a>
        <a onclick="mostrarUsersSection()">Usuarios</a>
        <a onclick="mostrarGeoballas()">Geoballas</a>
        <a onclick="cerrarSesion()">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n
        </a>
      </div>
    </div>
    <div class="container-admin">
      <h3><i class="fa-solid fa-file"></i> Panel de Administraci√≥n</h3>
      <p id="adminBienvenida">Bienvenido: <span id="adminNombre">[Nombre Usuario]</span></p>
      <p>Selecciona una opci√≥n del men√∫ superior para ver los reportes, estad√≠sticas o gestionar usuarios.</p>
      
      <!-- Secci√≥n Usuarios -->
      <div class="users-section" id="usersSection">
        <h4><i class="fa-solid fa-users"></i> Usuarios</h4>
        <div class="form-usuarios">
          <div class="row-fields">
            <div style="flex:1; min-width:200px;">
              <label for="usuarioDni">USUARIO (DNI)</label>
              <input type="text" id="usuarioDni" placeholder="DNI (8 d√≠gitos)" maxlength="8" pattern="^\d{8}$" oninput="this.value=this.value.replace(/\D/g,'').slice(0,8)">
            </div>
            <div style="flex:1; min-width:200px;">
              <label for="nombreCompleto">Nombre Completo</label>
              <input type="text" id="nombreCompleto" placeholder="Ej: Juan P√©rez">
            </div>
            <div style="flex:1; min-width:150px;">
              <label for="area">√Årea</label>
              <input type="text" id="area" placeholder="√Årea">
            </div>
            <div style="flex:1; min-width:150px;">
              <label for="cargo">Cargo</label>
              <input type="text" id="cargo" placeholder="Cargo">
            </div>
            <div style="flex:1; min-width:200px;">
              <label for="email">Email</label>
              <input type="text" id="email" placeholder="ejemplo@gmail.com">
            </div>
            <div style="flex:1; min-width:150px;">
              <label for="contrasenaUsuario">Contrase√±a</label>
              <input type="text" id="contrasenaUsuario" placeholder="8 d√≠gitos num√©ricos" pattern="^\d{8}$">
            </div>
            <div style="flex:1; min-width:100px;">
              <label for="nivel">Nivel</label>
              <input type="number" id="nivel" placeholder="0 o 1">
            </div>
            <div style="flex:1; min-width:120px;">
              <label for="horasExtras">HorasExtras</label>
              <input type="number" id="horasExtras" placeholder="0 o 1">
            </div>
          </div>
          <div class="actions-usuarios">
            <button class="btn-clean" onclick="limpiarFormulario()">
              <i class="fa-solid fa-eraser"></i> Limpiar
            </button>
            <button class="btn-save" id="guardarBtn" onclick="guardarUsuario()">
              <i class="fa-solid fa-floppy-disk"></i> Guardar
            </button>
          </div>
        </div>
        <div class="tabla-usuarios-container">
          <table class="tabla-usuarios" id="tablaUsuarios">
            <thead>
              <tr>
                <th>Acciones</th>
                <th>Nombre Completo</th>
                <th>USUARIO (DNI)</th>
                <th>Contrase√±a</th>
                <th>√Årea</th>
                <th>Cargo</th>
                <th>Email</th>
                <th>Nivel</th>
                <th>HorasExtras</th>
              </tr>
            </thead>
            <tbody id="tbodyUsuarios"></tbody>
          </table>
        </div>
      </div>
      <!-- Fin Secci√≥n Usuarios -->
      
      <!-- Secci√≥n Geoballas -->
      <div class="geoballas-section" id="geoballasSection">
        <h4><i class="fa-solid fa-map-location-dot"></i> Geoballas</h4>
        <table class="tabla-geoballas" id="tablaGeoballas">
          <thead>
            <tr>
              <th>Lugar</th>
              <th>Ubicaci√≥n</th>
              <th>Radio (m)</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyGeoballas"></tbody>
        </table>
        <h5>Agregar/Editar Geoballa</h5>
        <div class="input-group">
          <input type="text" id="geoballaLugar" placeholder="Lugar">
        </div>
        <!-- El campo de Ubicaci√≥n se llenar√° autom√°ticamente desde el mapa -->
        <div class="input-group">
          <input type="text" id="geoballaUbicacion" placeholder="Ubicaci√≥n (lat, lng)" readonly>
        </div>
        <div class="input-group">
          <input type="number" id="geoballaRadio" placeholder="Radio (m)">
        </div>
        <!-- Contenedor para el mapa interactivo -->
        <div id="map"></div>
        <button class="btn-blue" onclick="guardarGeoballa()">Guardar Geoballa</button>
      </div>
      <!-- Fin Secci√≥n Geoballas -->
      
    </div>
  </div>

  <!-- Fancy Alert Modal (Mensaje) -->
  <div id="fancyAlertOverlay">
    <div id="fancyAlertBox">
      <div class="fancyAlertHeader">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span id="fancyAlertTitle">¬°Atenci√≥n!</span>
      </div>
      <div id="fancyAlertMessage"></div>
      <button id="fancyAlertClose">Aceptar</button>
    </div>
  </div>

  <!-- Fancy Confirm Modal (Confirmaci√≥n personalizada) -->
  <div id="fancyConfirmOverlay">
    <div id="fancyConfirmBox">
      <div class="fancyAlertHeader">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span id="fancyConfirmTitle">Confirmar</span>
      </div>
      <div id="fancyConfirmMessage"></div>
      <div class="button-group-confirm">
        <button id="fancyConfirmYes">S√≠</button>
        <button id="fancyConfirmNo">No</button>
      </div>
    </div>
  </div>

  <script>
    /************** INICIALIZACI√ìN Y CONFIGURACI√ìN **************/
    function inicializarPagina() {
      document.getElementById("anio").textContent = new Date().getFullYear();
      const iconoOjo = document.getElementById("iconoOjo");
      iconoOjo.addEventListener("click", togglePassword);
      verificarSesionActiva();
    }

    /************** CONTROL DE SESI√ìN Y LOGIN **************/
    function verificarSesionActiva() {
      google.script.run.withSuccessHandler(function(estaActivo){
        if (estaActivo) {
          document.getElementById("loginDiv").classList.remove("visible");
          document.getElementById("loginDiv").classList.add("hidden");
          setTimeout(() => {
            document.getElementById("loginDiv").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("mainContent").classList.add("visible");
            obtenerNombreUsuario();
            obtenerNivelUsuario();
            cargarMarcacionesHoy();
          }, 300);
        } else {
          document.getElementById("loginDiv").classList.remove("hidden");
          document.getElementById("loginDiv").classList.add("visible");
          document.getElementById("mainContent").style.display = "none";
        }
      }).validarSesionActiva();
    }

    function enviarLogin() {
      const loginBtn = document.getElementById("loginBtn");
      const spinner = document.getElementById("loginSpinner");
      loginBtn.disabled = true;
      spinner.style.display = "block";
      const usuario = document.getElementById("usuario").value;
      const contrasena = document.getElementById("contrasena").value;
      google.script.run.withSuccessHandler(function(esValido){
        loginBtn.disabled = false;
        spinner.style.display = "none";
        if (esValido) {
          document.getElementById("loginDiv").classList.remove("visible");
          document.getElementById("loginDiv").classList.add("hidden");
          setTimeout(() => {
            document.getElementById("loginDiv").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("mainContent").classList.add("visible");
            obtenerNombreUsuario();
            obtenerNivelUsuario();
            cargarMarcacionesHoy();
          }, 300);
        } else {
          showFancyAlert("Contrase√±a incorrecta.");
        }
      }).validarLogin(usuario, contrasena);
    }

    function togglePassword() {
      const input = document.getElementById("contrasena");
      const icono = document.getElementById("iconoOjo");
      if (input.type === "password") {
        input.type = "text";
        icono.innerHTML = '<i class="fa-solid fa-eye"></i>';
      } else {
        input.type = "password";
        icono.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
      }
    }

    function obtenerNombreUsuario() {
      google.script.run.withSuccessHandler(function(nombre) {
        document.getElementById("bienvenida").innerText = "Bienvenido: " + nombre;
        document.getElementById("adminNombre").innerText = nombre;
      }).obtenerNombreUsuario();
    }

    function obtenerNivelUsuario() {
      google.script.run.withSuccessHandler(function(nivel) {
        if (Number(nivel) === 1) {
          document.getElementById("adminBtn").style.display = "block";
        } else {
          document.getElementById("adminBtn").style.display = "none";
        }
      }).obtenerNivelUsuario();
    }

    /************** MARCACIONES Y REGISTRO DE ASISTENCIA **************/
    function cargarMarcacionesHoy() {
      google.script.run.withSuccessHandler(function(registros) {
        const entradaDiv = document.getElementById("entradaLabel");
        const salidaDiv = document.getElementById("salidaLabel");
        entradaDiv.querySelector("span").textContent = "Entrada: --:--";
        salidaDiv.querySelector("span").textContent = "Salida: --:--";
        registros.forEach(r => {
          if (r.tipo === "Entrada") {
            entradaDiv.querySelector("span").textContent = `Entrada: ${r.fecha} ${r.hora}`;
          } else if (r.tipo === "Salida") {
            salidaDiv.querySelector("span").textContent = `Salida: ${r.fecha} ${r.hora}`;
          }
        });
      }).obtenerMarcacionesHoy();
    }

    function automatizarAsistencia() {
      google.script.run.withSuccessHandler(function(yaHayEntrada) {
        activarCamara(yaHayEntrada);
      }).verificarEntradaSinSalida();
    }

    let streamActivo = null;
    let ubicacionActual = "";
    let esEntradaPendiente = false;

    function activarCamara(yaHayEntrada) {
      esEntradaPendiente = !yaHayEntrada;
      if (streamActivo) return;
      const video = document.getElementById("video");
      video.style.display = "block";
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
        .then(function(stream) {
          video.srcObject = stream;
          streamActivo = stream;
          mostrarBotonRegistrar();
          obtenerUbicacion();
        })
        .catch(function(error) {
          showFancyAlert("No se pudo acceder a la c√°mara: " + error.message);
        });
    }

    function mostrarBotonRegistrar() {
      if (!document.getElementById("btnRegistrar")) {
        const btn = document.createElement("button");
        btn.setAttribute("id", "btnRegistrar");
        btn.classList.add("btn-orange");
        btn.innerHTML = '<i class="fa-solid fa-check"></i> REGISTRAR';
        btn.onclick = () => {
          btn.disabled = true;
          capturarFotoYRegistrar();
        };
        document.getElementById("mainContent").appendChild(btn);
      }
    }

    function obtenerUbicacion() {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          position => {
            ubicacionActual = `${position.coords.latitude}, ${position.coords.longitude}`;
          },
          error => {
            console.warn("Error GPS:", error.message);
            ubicacionActual = "No disponible";
          }
        );
      } else {
        ubicacionActual = "No soportado";
      }
    }

function capturarFotoYRegistrar() {
  const video = document.getElementById("video");
  if (!video) return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  canvas.toBlob(blob => {
    const reader = new FileReader();
    reader.onloadend = function () {
      const base64Img = reader.result.split(',')[1];

      if (!ubicacionActual || ubicacionActual === "No disponible" || ubicacionActual === "No soportado") {
        showFancyAlert("No se pudo capturar la ubicaci√≥n GPS. Aseg√∫rate de tener el GPS activado.");
        stopCamera();
        return;
      }

      const tipoEvento = esEntradaPendiente ? "Entrada" : "Salida";

      // Funci√≥n para continuar con la validaci√≥n de geoballa y el registro
      function proceedWithRegistro() {
        // Paso 2: Validar geoballa
        google.script.run.withSuccessHandler(function (geoResult) {
          if (!geoResult || !geoResult.dentro) {
            const msg = geoResult
              ? `Est√°s a ${geoResult.distancia} metros de "${geoResult.lugar}".\nRadio permitido: ${geoResult.radio} m.\nNo puedes marcar asistencia.`
              : "No se encontr√≥ ninguna zona geogr√°fica autorizada para marcar.";
            showFancyAlert(msg);
            stopCamera();
            return;
          }

          // Paso 3: Subir imagen y registrar asistencia
          google.script.run.withSuccessHandler(function (resFinal) {
            if (resFinal.lugar) {
              let icono = "‚úÖ";
              let titulo = "¬°Registro exitoso!";
              const mensaje = resFinal.mensaje || "";

              if (mensaje.toLowerCase().includes("puntual")) {
                icono = "‚è∞";
                titulo = "Entrada puntual";
              } else if (mensaje.toLowerCase().includes("tarde")) {
                icono = "‚ö†Ô∏è";
                titulo = "Entrada tard√≠a";
              } else if (tipoEvento === "Salida") {
                icono = "üëã";
                titulo = "Salida registrada";
              }

              // Extraer frase si hay salto de l√≠nea
              const partes = mensaje.split("\n");
              const frase = partes.slice(1).join("\n").trim();

              const mensajeFinal = `${icono} ${titulo}\nüìç Lugar: ${resFinal.lugar}\n\n${frase || "¬°Buen trabajo!"}`;
              showFancyAlert(mensajeFinal);
            } else {
              showFancyAlert(resFinal.mensaje);
            }

            stopCamera();
            cargarMarcacionesHoy();
          }).subirYRegistrarAsistencia(base64Img, ubicacionActual, tipoEvento);

        }).verificarGeoballa(ubicacionActual);
      }

      // Paso 1: Validar horario
      google.script.run.withSuccessHandler(function (respuesta) {
        if (respuesta.permitido === true) {
          proceedWithRegistro();
        } else if (respuesta.permitido === "confirm") {
          showFancyConfirm(
            respuesta.mensaje,
            function () { // Si acepta
              proceedWithRegistro();
            },
            function () { // Si cancela
              stopCamera();
            }
          );
        } else {
          showFancyAlert(respuesta.mensaje);
          stopCamera();
          return;
        }
      }).validarHorario(tipoEvento);
    };
    reader.readAsDataURL(blob);
  }, 'image/jpeg');
}

    function stopCamera() {
      if (streamActivo) {
        streamActivo.getTracks().forEach(track => track.stop());
        streamActivo = null;
      }
      const video = document.getElementById("video");
      video.style.display = "none";
      const btnRegistrar = document.getElementById("btnRegistrar");
      if (btnRegistrar) btnRegistrar.remove();
    }

    /************** PANEL DE ADMINISTRACI√ìN Y USUARIOS **************/
    function mostrarAdminPanel() {
      document.getElementById("mainContent").classList.remove("visible");
      document.getElementById("mainContent").classList.add("hidden");
      setTimeout(() => {
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        document.getElementById("adminPanel").classList.add("visible");
        document.getElementById("usersSection").style.display = "none";
        document.getElementById("geoballasSection").style.display = "none";
      }, 300);
    }

    function mostrarUsersSection() {
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("usersSection").style.display = "block";
      document.getElementById("geoballasSection").style.display = "none";
      google.script.run.withSuccessHandler(renderizarUsuarios).obtenerListaUsuarios();
    }

    // Funci√≥n para mostrar la secci√≥n de Geoballas
  function mostrarGeoballas() {
  document.getElementById("adminPanel").style.display = "block";
  document.getElementById("usersSection").style.display = "none";
  document.getElementById("geoballasSection").style.display = "block";
  google.script.run.withSuccessHandler(renderizarGeoballas).obtenerGeoballas();
  
  // Reinicializar el mapa para geoballas y forzar resize
  if (typeof initMap === "function") {
    initMap();
  }
  // Espera un poco para que el contenedor se muestre y luego dispara el resize
  setTimeout(function() {
    google.maps.event.trigger(map, "resize");
    // Opcional: rec√©ntralo en la posici√≥n actual o en una predeterminada
    map.setCenter({ lat: -8.109, lng: -79.021 }); // O la posici√≥n deseada
  }, 100);
}


    function renderizarUsuarios(lista) {
      const tbody = document.getElementById("tbodyUsuarios");
      tbody.innerHTML = "";
      lista.forEach(usuario => {
        const tr = document.createElement("tr");

        // Columna de Acciones (√≠conos)
        const tdAcciones = document.createElement("td");

        const btnEdit = document.createElement("button");
        btnEdit.classList.add("btn-icon", "edit");
        btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
        btnEdit.onclick = () => confirmarEdicionUsuario(usuario);

        const btnDelete = document.createElement("button");
        btnDelete.classList.add("btn-icon", "delete");
        btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
        btnDelete.onclick = () => eliminarUsuario(usuario.dni);

        tdAcciones.appendChild(btnEdit);
        tdAcciones.appendChild(btnDelete);
        tr.appendChild(tdAcciones);

        // Resto de columnas
        const tdNombre = document.createElement("td");
        tdNombre.textContent = usuario.nombre || "";
        tr.appendChild(tdNombre);

        const tdDni = document.createElement("td");
        tdDni.textContent = usuario.dni || "";
        tr.appendChild(tdDni);

        const tdContra = document.createElement("td");
        tdContra.textContent = usuario.contrasena || "";
        tr.appendChild(tdContra);

        const tdArea = document.createElement("td");
        tdArea.textContent = usuario.area || "";
        tr.appendChild(tdArea);

        const tdCargo = document.createElement("td");
        tdCargo.textContent = usuario.cargo || "";
        tr.appendChild(tdCargo);

        const tdEmail = document.createElement("td");
        tdEmail.textContent = usuario.email || "";
        tr.appendChild(tdEmail);

        const tdNivel = document.createElement("td");
        tdNivel.textContent = usuario.nivel || 0;
        tr.appendChild(tdNivel);

        const tdHoras = document.createElement("td");
        tdHoras.textContent = usuario.horasExtras || 0;
        tr.appendChild(tdHoras);

        tbody.appendChild(tr);
      });
    }

    // Funci√≥n para renderizar la lista de geoballas
    function renderizarGeoballas(geoballas) {
      const tbody = document.getElementById("tbodyGeoballas");
      tbody.innerHTML = "";
      geoballas.forEach(geo => {
        const tr = document.createElement("tr");
        
        const tdLugar = document.createElement("td");
        tdLugar.textContent = geo.lugar || "";
        tr.appendChild(tdLugar);
        
        const tdUbicacion = document.createElement("td");
        tdUbicacion.textContent = geo.ubicacion || "";
        tr.appendChild(tdUbicacion);
        
        const tdRadio = document.createElement("td");
        tdRadio.textContent = geo.radio || "";
        tr.appendChild(tdRadio);
        
        const tdAcciones = document.createElement("td");
        const btnEdit = document.createElement("button");
        btnEdit.classList.add("btn-icon", "edit");
        btnEdit.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
        btnEdit.onclick = () => confirmarEdicionGeoballa(geo);
        const btnDelete = document.createElement("button");
        btnDelete.classList.add("btn-icon", "delete");
        btnDelete.innerHTML = '<i class="fa-solid fa-trash"></i>';
        btnDelete.onclick = () => eliminarGeoballa(geo.lugar);
        tdAcciones.appendChild(btnEdit);
        tdAcciones.appendChild(btnDelete);
        tr.appendChild(tdAcciones);
        
        tbody.appendChild(tr);
      });
    }

    // Funciones para confirmar, editar y eliminar usuarios y geoballas
    function confirmarEdicionUsuario(usuario) {
      showFancyConfirm(
        `¬øEst√° seguro de que desea editar al usuario con DNI: ${usuario.dni}?`,
        () => {
          editarUsuario(usuario);
        },
        () => {
          console.log("Edici√≥n cancelada");
        }
      );
    }
    function confirmarEdicionGeoballa(geo) {
  showFancyConfirm(
    `¬øEst√° seguro de que desea editar la geoballa para el lugar: ${geo.lugar}?`,
    () => {
      // Si el usuario confirma
      editarGeoballa(geo);
    },
    () => {
      // Si el usuario cancela
      console.log("Edici√≥n de geoballa cancelada");
    }
  );
}

    function editarUsuario(usuario) {
      document.getElementById("usuarioDni").value = usuario.dni;
      document.getElementById("nombreCompleto").value = usuario.nombre;
      document.getElementById("area").value = usuario.area;
      document.getElementById("cargo").value = usuario.cargo;
      document.getElementById("email").value = usuario.email;
      document.getElementById("contrasenaUsuario").value = usuario.contrasena;
      document.getElementById("nivel").value = usuario.nivel;
      document.getElementById("horasExtras").value = usuario.horasExtras;
    }

    function eliminarUsuario(dni) {
      showFancyConfirm(
        `¬øEst√° seguro de que desea eliminar al usuario con DNI: ${dni}?\nEsta acci√≥n no se puede deshacer.`,
        () => {
          google.script.run.withSuccessHandler((exito) => {
            if (exito) {
              showFancyAlert("Usuario eliminado correctamente.");
            } else {
              showFancyAlert(`No se encontr√≥ el usuario con DNI: ${dni}.`);
            }
            google.script.run.withSuccessHandler(renderizarUsuarios).obtenerListaUsuarios();
          }).eliminarUsuario(dni);
        },
        () => {
          console.log("Eliminaci√≥n cancelada");
        }
      );
    }

    // Funciones para geoballas
function editarGeoballa(geo) {
  document.getElementById("geoballaLugar").value = geo.lugar;
  document.getElementById("geoballaUbicacion").value = geo.ubicacion;
  document.getElementById("geoballaRadio").value = geo.radio;
  
  if (map) {
    var parts = geo.ubicacion.split(",");
    var lat = parseFloat(parts[0].trim());
    var lng = parseFloat(parts[1].trim());
    var newPos = { lat, lng };

    // Si no existe el marcador, se crea con el logo; de lo contrario, se actualiza
    if (!marker) {
      marker = new google.maps.Marker({
        position: newPos,
        map: map,
        icon: {
          url: "https://i.imgur.com/tud5XMS.png",
          scaledSize: new google.maps.Size(32, 32)
        }
      });
    } else {
      marker.setPosition(newPos);
    }

    // Actualizar o crear el c√≠rculo en la posici√≥n y con el radio especificado
    updateCircle(newPos);

    // Centrar el mapa en la nueva posici√≥n
    map.setCenter(newPos);
  }
}


    function eliminarGeoballa(lugar) {
      showFancyConfirm(
        `¬øEst√° seguro de que desea eliminar la geoballa para el lugar: ${lugar}?`,
        () => {
          google.script.run.withSuccessHandler(function(res) {
            showFancyAlert(res.mensaje);
            mostrarGeoballas();
          }).eliminarGeoballa(lugar);
        },
        () => {
          console.log("Eliminaci√≥n de geoballa cancelada");
        }
      );
    }

    function guardarGeoballa() {
      const lugar = document.getElementById("geoballaLugar").value.trim();
      const ubicacion = document.getElementById("geoballaUbicacion").value.trim();
      const radio = document.getElementById("geoballaRadio").value.trim();
      if (!lugar || !ubicacion || !radio) {
        showFancyAlert("Por favor, complete todos los campos de la geoballa.");
        return;
      }
      const geoObj = { lugar, ubicacion, radio: parseFloat(radio) };
      google.script.run.withSuccessHandler(function(res) {
        showFancyAlert(res.mensaje);
        mostrarGeoballas();
      }).guardarGeoballa(geoObj);
    }

    function limpiarFormulario() {
      document.getElementById("usuarioDni").value = "";
      document.getElementById("nombreCompleto").value = "";
      document.getElementById("area").value = "";
      document.getElementById("cargo").value = "";
      document.getElementById("email").value = "";
      document.getElementById("contrasenaUsuario").value = "";
      document.getElementById("nivel").value = "";
      document.getElementById("horasExtras").value = "";
    }

    function guardarUsuario() {
      const dni = document.getElementById("usuarioDni").value.trim();
      const nombre = document.getElementById("nombreCompleto").value.trim();
      const area = document.getElementById("area").value.trim();
      const cargo = document.getElementById("cargo").value.trim();
      const email = document.getElementById("email").value.trim();
      const contrasena = document.getElementById("contrasenaUsuario").value.trim();
      const nivel = document.getElementById("nivel").value.trim();
      const horasExtras = document.getElementById("horasExtras").value.trim();

      if (!/^\d{8}$/.test(dni)) {
        showFancyAlert("El DNI debe ser un n√∫mero de 8 d√≠gitos.");
        return;
      }
      if (!/^\d{8}$/.test(contrasena)) {
        showFancyAlert("La contrase√±a debe tener exactamente 8 d√≠gitos num√©ricos.");
        return;
      }

      const userObj = {
        dni,
        nombre,
        area,
        cargo,
        email,
        contrasena,
        nivel: parseInt(nivel, 10),
        horasExtras: parseInt(horasExtras, 10)
      };

      const guardarBtn = document.getElementById("guardarBtn");
      guardarBtn.disabled = true;
      google.script.run
        .withSuccessHandler(() => {
          showFancyAlert("Usuario guardado correctamente.");
          limpiarFormulario();
          google.script.run.withSuccessHandler(renderizarUsuarios).obtenerListaUsuarios();
          guardarBtn.disabled = false;
        })
        .withFailureHandler(err => {
          showFancyAlert("Error al guardar usuario: " + err.message);
          guardarBtn.disabled = false;
        })
        .guardarUsuarioEnHoja(userObj);
    }

    /************** CIERRE DE SESI√ìN **************/
    function cerrarSesion() {
      google.script.run.withSuccessHandler(() => {
        document.getElementById("adminPanel").classList.remove("visible");
        document.getElementById("adminPanel").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("visible");
        document.getElementById("mainContent").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("adminPanel").style.display = "none";
          document.getElementById("mainContent").style.display = "none";
          document.getElementById("loginDiv").style.display = "block";
          document.getElementById("loginDiv").classList.add("visible");
          document.getElementById("usuario").value = "";
          document.getElementById("contrasena").value = "";
        }, 300);
      }).cerrarSesion();
    }

    /************** FANCY ALERT (Mensaje) **************/
    function showFancyAlert(message) {
      const overlay = document.getElementById("fancyAlertOverlay");
      const msg = document.getElementById("fancyAlertMessage");
      msg.textContent = message;
      overlay.classList.add("active");
    }
    function closeFancyAlert() {
      const overlay = document.getElementById("fancyAlertOverlay");
      overlay.classList.remove("active");
    }
    document.getElementById("fancyAlertClose").addEventListener("click", closeFancyAlert);

    /************** FANCY CONFIRM (Confirmaci√≥n personalizada) **************/
    function showFancyConfirm(message, onYes, onNo) {
      const overlay = document.getElementById("fancyConfirmOverlay");
      const msg = document.getElementById("fancyConfirmMessage");
      msg.textContent = message;
      overlay.classList.add("active");
      const btnYes = document.getElementById("fancyConfirmYes");
      const btnNo = document.getElementById("fancyConfirmNo");
      btnYes.onclick = null;
      btnNo.onclick = null;
      btnYes.onclick = () => {
        overlay.classList.remove("active");
        if (typeof onYes === "function") onYes();
      };
      btnNo.onclick = () => {
        overlay.classList.remove("active");
        if (typeof onNo === "function") onNo();
      };
    }

    /************** ESTAD√çSTICAS Y REPORTES **************/
    function mostrarEstadisticas() {
      document.getElementById("adminPanel").classList.remove("hidden");
      document.getElementById("adminPanel").classList.add("visible");
      document.getElementById("usersSection").style.display = "none";
      document.getElementById("geoballasSection").style.display = "none";
      google.script.run.withSuccessHandler(function(stats) {
        let mensaje = "Estad√≠sticas generales:\n";
        mensaje += "Total Registros: " + stats.totalRegistros + "\n";
        mensaje += "Total Entradas: " + stats.totalEntradas + "\n";
        mensaje += "Total Salidas: " + stats.totalSalidas + "\n\n";
        mensaje += "Registros por Usuario:\n";
        for (let dni in stats.registrosPorUsuario) {
          mensaje += dni + ": " + stats.registrosPorUsuario[dni] + "\n";
        }
        showFancyAlert(mensaje);
      }).obtenerEstadisticas();
    }

    function reporteGeneral() {
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("usersSection").style.display = "none";
      document.getElementById("geoballasSection").style.display = "none";
      showFancyAlert("Funci√≥n de Reporte General en construcci√≥n...");
    }

    function reporteIndividual() {
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("usersSection").style.display = "none";
      document.getElementById("geoballasSection").style.display = "none";
      showFancyAlert("Funci√≥n de Reporte Individual en construcci√≥n...");
    }

    function registroAsistencia() {
      showFancyAlert("Funci√≥n de Registro de Asistencias en construcci√≥n...");
    }
    
    /* ============ Funciones para el mapa de Geoballas ============ */
    var map;  // Variable global para el mapa
    var marker; // Variable global para el marcador
    var circle; // Variable global para el c√≠rculo

function updateCircle(center) {
  // Obtener el valor del radio desde el campo de entrada (puedes definir un valor por defecto si no se ingresa nada)
  var radioInput = document.getElementById("geoballaRadio").value;
  var radio = parseFloat(radioInput);
  if (isNaN(radio)) radio = 50; // Valor predeterminado en metros

  // Si el c√≠rculo a√∫n no existe, se crea; de lo contrario, se actualiza su centro y radio
  if (!circle) {
    circle = new google.maps.Circle({
      map: map,
      center: center,
      radius: radio,
      fillColor: "#FF0000",     // Color de relleno
      fillOpacity: 0.2,         // Opacidad del relleno
      strokeColor: "#FF0000",   // Color del borde
      strokeOpacity: 0.8,       // Opacidad del borde
      strokeWeight: 2           // Grosor del borde
    });
  } else {
    circle.setCenter(center);
    circle.setRadius(radio);
  }
}


function initMap() {
  const defaultLatLng = { lat: -8.109, lng: -79.021 }; // Ejemplo: Trujillo, Per√∫
  map = new google.maps.Map(document.getElementById("map"), {
    center: defaultLatLng,
    zoom: 15,
  });

  // Si deseas crear un marcador inicial, tambi√©n lo haces con el icono personalizado:
  marker = new google.maps.Marker({
    position: defaultLatLng,
    map: map,
    icon: {
      url: "https://i.imgur.com/tud5XMS.png",
      scaledSize: new google.maps.Size(32, 32)
    }
  });

  // Inicializar el c√≠rculo con la posici√≥n por defecto
  updateCircle(defaultLatLng);

  // Escuchar clics en el mapa para actualizar el marcador y el c√≠rculo
  map.addListener("click", (e) => {
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    const newPos = { lat, lng };

    // Actualizar o crear el marcador
    if (!marker) {
      marker = new google.maps.Marker({
        position: newPos,
        map: map,
        icon: {
          url: "https://i.imgur.com/tud5XMS.png",
          scaledSize: new google.maps.Size(32, 32)
        }
      });
    } else {
      marker.setPosition(newPos);
    }

    // Actualizar el c√≠rculo con la nueva posici√≥n
    updateCircle(newPos);

    // Actualizar el campo de ubicaci√≥n en el formulario
    document.getElementById("geoballaUbicacion").value = lat + "," + lng;
  });
}


  </script>
  <!-- Incluir el script de Google Maps con tu API key -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4YhQYvvHu7g53Xf53jDHGleUJYVAt1cA&callback=initMap">
  </script>
</body>
</html>
